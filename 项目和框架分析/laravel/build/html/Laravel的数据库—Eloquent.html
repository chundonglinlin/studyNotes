

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>60. Eloquent &mdash; laravel 1.0 文档</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="索引"
              href="genindex.html"/>
        <link rel="search" title="搜索" href="search.html"/>
    <link rel="top" title="laravel 1.0 文档" href="index.html"/>
        <link rel="next" title="61. Eloquent关联" href="Laravel的数据库—Eloquent关联.html"/>
        <link rel="prev" title="59. Redis原理分析" href="Laravel的Redis原理分析.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> laravel
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">目录:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="请求到响应的生命周期-web.html">1. 请求到web响应的生命周期</a></li>
<li class="toctree-l1"><a class="reference internal" href="请求到响应的生命周期-console.html">2. 请求到console响应的生命周期</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的容器.html">3. 容器</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Facades.html">4. Facades</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Facades原理分析.html">5. Facade的原理</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的服务提供器.html">6. 服务提供器</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的路由.html">7. 路由</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的路由—路由的正则编译.html">8. 路由的正则编译</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的路由—路由的匹配与参数绑定.html">9. 路由的匹配与参数绑定</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的路由—路由中间件.html">10. 路由的中间件</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的中间件.html">11. 中间件</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的中间件-SubstituteBindings.html">12. 中间件SubstituteBindings</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的中间件-CSRF.html">13. 中间件CSRF</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的请求.html">14. 请求</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的控制器.html">15. 控制器</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的控制器—控制器方法的参数构建与运行.html">16. 控制器方法的参数构建与运行</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的响应.html">17. 响应</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的视图.html">18. 视图</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的生成URL.html">19. URL</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Session.html">20. Session</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Session原理分析.html">21. Session原理分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的表单验证机制详解.html">22. 表单验证机制详解</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的日志.html">23. 日志</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的异常和错误处理.html">24. 异常和错误处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的异常和错误处理原理分析.html">25. 异常和错误处理原理分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Blade.html">26. Blade</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的blade原理分析.html">27. Blade原理分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的前端.html">28. 前端</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Mix.html">29. Mix</a></li>
<li class="toctree-l1"><a class="reference internal" href="laravel-mix.html">30. mix使用手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的用户认证系统.html">31. Laravel 的用户认证系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="用户认证JWT.html">32. 用户认证JWT</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的API认证系统Passport.html">33. Laravel 的 API 认证系统 Passport</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的用户授权系统.html">34. Laravel用户授权系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的命令行.html">35. 命令行</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的广播系统.html">36. 广播</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的广播系统原理分析.html">37. 广播系统原理分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的缓存系统.html">38. 缓存</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的集合Collection.html">39. 集合</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的事件系统.html">40. 事件</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的事件系统原理分析.html">41. 事件系统原理分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的文件存储.html">42. 文件存储</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的辅助函数-字符串操作.html">43. 辅助函数-字符串函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的辅助函数-数组和对象操作.html">44. 辅助函数-数组和对象函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的辅助函数-路径操作.html">45. 辅助函数-路径函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的辅助函数-tap分析.html">46. 辅助函数-Tap函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的辅助函数-其它.html">47. 辅助函数-其它杂项</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的邮件发送功能.html">48. 邮件</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的消息通知.html">49. 通知</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel Queue——消息队列任务与分发源码剖析.html">50. 消息队列任务与分发源码剖析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的任务调度.html">51. 任务调度</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据库—原始方式.html">52. 数据库-原始操作</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据库—查询构造器.html">53. 数据库-查询构建器</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据分页.html">54. 数据分页</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据分页原理分析.html">55. 数据分页原理分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据库迁移.html">56. 数据库迁移</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据库填充.html">57. 数据库填充</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Redis.html">58. Redis</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Redis原理分析.html">59. Redis原理分析</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">60. Eloquent</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">60.1. 简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id2">60.2. 定义模型</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id3">60.2.1. Eloquent 模型约定</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id8">60.3. 获取模型</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id9">60.3.1. 集合</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">60.3.2. 分块结果</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id11">60.3.3. 使用游标</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id12">60.4. 检索单个模型／集合</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id13">60.4.1. 检索聚合</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id14">60.5. 插入 &amp; 更新模型</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id15">60.5.1. 插入</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id16">60.5.2. 更新</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id18">60.5.3. 批量赋值</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id20">60.5.4. 其它创建方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id21">60.6. 删除模型</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id22">60.6.1. 通过主键删除模型</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id23">60.6.2. 通过查询删除模型</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id24">60.6.3. 软删除</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id30">60.7. 查询作用域</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id31">60.7.1. 全局作用域</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id36">60.7.2. 本地作用域</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id38">60.7.3. 动态作用域(全局作用域可以传入参数么？？)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id39">60.8. 事件</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id40">60.8.1. 观察者</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据库—Eloquent关联.html">61. Eloquent关联</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据库—Eloquent修改器.html">62. Eloquent修改器</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的验证规则.html">63. 验证规则</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">laravel</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>60. Eloquent</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
        
        <a href="http://blog.liaozhonghao.cn" rel="nofollow"> 返回主页</a>
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="eloquent">
<h1>60. Eloquent<a class="headerlink" href="#eloquent" title="永久链接至标题">¶</a></h1>
<div class="section" id="id1">
<h2>60.1. 简介<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>Laravel 的 Eloquent ORM 提供了漂亮、简洁的 <code class="docutils literal"><span class="pre">ActiveRecord</span></code> 实现来和数据库交互。每个数据库表都有一个对应的「模型」用来与该表交互。你可以通过模型查询数据表中的数据，并将新记录添加到数据表中。</p>
<p>在开始之前，请确保在 <code class="docutils literal"><span class="pre">config/database.php</span></code> 中配置数据库连接。更多关于数据库的配置信息，请查看 文档。</p>
</div>
<div class="section" id="id2">
<h2>60.2. 定义模型<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>首先，创建一个 <code class="docutils literal"><span class="pre">Eloquent</span></code> 模型，生成的模型通常放在 <code class="docutils literal"><span class="pre">app</span></code> 目录中，但你可以通过 <code class="docutils literal"><span class="pre">composer.json</span></code> 文件随意地将它们放在可被自动加载的地方。所有的 <code class="docutils literal"><span class="pre">Eloquent</span></code> 模型都继承了 <code class="docutils literal"><span class="pre">Illuminate\Database\Eloquent\Model</span></code> 类。</p>
<p>创建模型实例的最简单方法是使用 <code class="docutils literal"><span class="pre">Artisan</span></code> 命令 <code class="docutils literal"><span class="pre">make:model</span></code> ：</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>php artisan make:model User
</pre></div>
</div>
<p>如果要在生成模型时生成 数据库迁移 ，可以使用 <code class="docutils literal"><span class="pre">--migration</span></code> 或 <code class="docutils literal"><span class="pre">-m</span></code> 选项：</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>php artisan make:model User --migration

php artisan make:model User -m
</pre></div>
</div>
<div class="section" id="id3">
<h3>60.2.1. Eloquent 模型约定<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h3>
<p>现在，我们来看一个 <code class="docutils literal"><span class="pre">Flight</span></code> 模型类的例子，我们将会用它从 <code class="docutils literal"><span class="pre">flights</span></code> 数据表中检索和存储信息：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Flight</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">//</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="id4">
<h4>60.2.1.1. 数据表名称<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h4>
<p>请注意，我们并没有告诉 <code class="docutils literal"><span class="pre">Eloquent</span></code> ， <code class="docutils literal"><span class="pre">Flight</span></code> 模型该使用哪一个数据表。除非数据表明确地指定了其它名称，否则将使用类的复数形式「蛇形命名」来作为表名。因此，在这种情况下， <code class="docutils literal"><span class="pre">Eloquent</span></code> 会假定 <code class="docutils literal"><span class="pre">Flight</span></code> 模型存储的是 <code class="docutils literal"><span class="pre">flights</span></code> 数据表中的记录。你可以通过在模型上定义 <code class="docutils literal"><span class="pre">table</span></code> 属性，来指定自定义数据表：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Flight</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 与模型关联的数据表。</span>
<span class="sd">     *</span>
<span class="sd">     * @var string</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$table</span> <span class="o">=</span> <span class="s1">&#39;my_flights&#39;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h4>60.2.1.2. 主键<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h4>
<p><code class="docutils literal"><span class="pre">Eloquent</span></code> 也会假定每个数据表都有一个名为 <code class="docutils literal"><span class="pre">id</span></code> 的主键字段。你可以定义一个访问权限为 <code class="docutils literal"><span class="pre">protected</span></code> 的 <code class="docutils literal"><span class="pre">$primaryKey</span></code> 属性来覆盖这个约定。</p>
<p>另外， <code class="docutils literal"><span class="pre">Eloquent</span></code> 假定主键是一个递增的整数值，这意味着在默认情况下主键会自动转换为 <code class="docutils literal"><span class="pre">int</span></code> 且不需要用户赋值。如果希望使用非递增或者非数字的主键，则必须在模型上设置 <code class="docutils literal"><span class="pre">public</span> <span class="pre">$incrementing</span> <span class="pre">=</span> <span class="pre">false</span></code> 每次进行插入数据的时候，需要手动给主键赋值。如果主键不是一个整数，你应该在模型上设置 <code class="docutils literal"><span class="pre">protected</span> <span class="pre">$keyType</span> <span class="pre">=</span> <span class="pre">string</span></code> 。</p>
</div>
<div class="section" id="id6">
<h4>60.2.1.3. 时间戳<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h4>
<p>默认情况下， <code class="docutils literal"><span class="pre">Eloquent</span></code> 会默认数据表中存在 <code class="docutils literal"><span class="pre">created_at</span></code> 和 <code class="docutils literal"><span class="pre">updated_at</span></code> 这两个字段。如果你不需要这两个字段，则需要在模型内将 <code class="docutils literal"><span class="pre">$timestamps</span></code> 属性设置为 <code class="docutils literal"><span class="pre">false</span></code> ：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Flight</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 该模型是否被自动维护时间戳</span>
<span class="sd">     *</span>
<span class="sd">     * @var bool</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="nv">$timestamps</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>如果你需要自定义时间戳格式，可在模型内设置 <code class="docutils literal"><span class="pre">$dateFormat</span></code> 属性。这个属性决定了日期属性应如何存储在数据库中，以及模型被序列化成数组或 <code class="docutils literal"><span class="pre">JSON</span></code> 时的格式：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Flight</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 模型的日期字段的存储格式</span>
<span class="sd">     *</span>
<span class="sd">     * @var string</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$dateFormat</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span><span class="p">;</span> <span class="c1">//从 Unix 纪元（January 1 1970 00:00:00 GMT）开始至今的秒数</span>
<span class="p">}</span>
</pre></div>
</div>
<p>如果你需要自定义用于存储时间戳的字段名，可以在模型中通过设置 <code class="docutils literal"><span class="pre">CREATED_AT</span></code> 和 <code class="docutils literal"><span class="pre">UPDATED_AT</span></code> 常量来实现：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">Flight</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="no">CREATED_AT</span> <span class="o">=</span> <span class="s1">&#39;creation_date&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">UPDATED_AT</span> <span class="o">=</span> <span class="s1">&#39;last_update&#39;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h4>60.2.1.4. 数据库连接<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h4>
<p>默认情况下，所有的模型使用应用配置中的默认数据库连接。如果你想要为模型指定不同的连接，可以通过 <code class="docutils literal"><span class="pre">$connection</span></code> 属性来设置：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Flight</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 数据模型专属的数据库连接</span>
<span class="sd">     *</span>
<span class="sd">     * @var string</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$connection</span> <span class="o">=</span> <span class="s1">&#39;connection-name&#39;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id8">
<h2>60.3. 获取模型<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h2>
<p>创建完模型及其 关联数据表 之后，就可以从数据库中获取数据了。将每个 <code class="docutils literal"><span class="pre">Eloquent</span></code> 模型想像成强大的 查询构造器，你可以使用它来流畅的查询与其关联的数据表。例如：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">App\Flight</span><span class="p">;</span>

<span class="nv">$flights</span> <span class="o">=</span> <span class="nx">App\Flight</span><span class="o">::</span><span class="na">all</span><span class="p">();</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$flights</span> <span class="k">as</span> <span class="nv">$flight</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$flight</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>添加其他约束</strong></p>
<p><code class="docutils literal"><span class="pre">Eloquent</span></code> 的 <code class="docutils literal"><span class="pre">all</span></code> 方法会返回模型表中的所有结果。由于每个 <code class="docutils literal"><span class="pre">Eloquent</span></code> 模型都可以当作一个 查询构造器 ，因此你还可以在查询中添加约束，然后使用 <code class="docutils literal"><span class="pre">get</span></code> 来获取结果：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$flights</span> <span class="o">=</span> <span class="nx">App\Flight</span><span class="o">::</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
               <span class="o">-&gt;</span><span class="na">orderBy</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">)</span>
               <span class="o">-&gt;</span><span class="na">take</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
               <span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">小技巧</p>
<p class="last"><code class="docutils literal"><span class="pre">Eloquent</span></code> 模型是查询构造器，因此你应当去阅读 查询构造器 提供的所有方法，以便你可以在 <code class="docutils literal"><span class="pre">Eloquent</span></code> 查询中使用。</p>
</div>
<div class="section" id="id9">
<h3>60.3.1. 集合<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h3>
<p>使用 <code class="docutils literal"><span class="pre">Eloquent</span></code> 中的 <code class="docutils literal"><span class="pre">all</span></code> 和 <code class="docutils literal"><span class="pre">get</span></code> 方法可以检索多个结果，并会返回一个 <code class="docutils literal"><span class="pre">Illuminate\Database\Eloquent\Collection</span></code> 实例。 <code class="docutils literal"><span class="pre">Collection</span></code> 类提供了 很多辅助函数 来处理 <code class="docutils literal"><span class="pre">Eloquent</span></code> 结果。</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$flights</span> <span class="o">=</span> <span class="nv">$flights</span><span class="o">-&gt;</span><span class="na">reject</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$flight</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$flight</span><span class="o">-&gt;</span><span class="na">cancelled</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>你也可以像数组一样简单地来遍历集合：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$flights</span> <span class="k">as</span> <span class="nv">$flight</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$flight</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id10">
<h3>60.3.2. 分块结果<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h3>
<p>如果你需要处理数千个 <code class="docutils literal"><span class="pre">Eloquent</span></code> 结果，可以使用 <code class="docutils literal"><span class="pre">chunk</span></code> 命令。 <code class="docutils literal"><span class="pre">chunk</span></code> 方法会检索 <code class="docutils literal"><span class="pre">Eloquent</span></code> 模型的『分块』，将它们提供给指定的 <code class="docutils literal"><span class="pre">Closure</span></code> 进行处理。在处理大型结果集时，使用 <code class="docutils literal"><span class="pre">chunk</span></code> 方法可节省内存：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nx">Flight</span><span class="o">::</span><span class="na">chunk</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$flights</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$flights</span> <span class="k">as</span> <span class="nv">$flight</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
<p>传递到方法的第一个参数是希望每个『分块』接收的数据量。闭包则作为第二个参数传递，它会在每次执行数据库查询传递每个块时被调用。</p>
</div>
<div class="section" id="id11">
<h3>60.3.3. 使用游标<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal"><span class="pre">cursor</span></code> 方法允许你使用游标来遍历数据库数据，该游标只执行一个查询。处理大量数据时，使用 <code class="docutils literal"><span class="pre">cursor</span></code> 方法可以大幅度减少内存的使用量：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nx">Flight</span><span class="o">::</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$flight</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id12">
<h2>60.4. 检索单个模型／集合<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h2>
<p>除了从指定的数据表检索所有记录外，你也可以通过 <code class="docutils literal"><span class="pre">find</span></code> 或 <code class="docutils literal"><span class="pre">first</span></code> 方法来检索单条记录。这些方法不是返回一组模型，而是返回一个模型实例：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// 通过主键取回一个模型...</span>
<span class="nv">$flight</span> <span class="o">=</span> <span class="nx">App\Flight</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="c1">// 取回符合查询限制的第一个模型...</span>
<span class="nv">$flight</span> <span class="o">=</span> <span class="nx">App\Flight</span><span class="o">::</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">first</span><span class="p">();</span>
</pre></div>
</div>
<p>你也可以使用主键数组作为参数调用 <code class="docutils literal"><span class="pre">find</span></code> 方法，它将返回匹配记录的集合：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$flights</span> <span class="o">=</span> <span class="nx">App\Flight</span><span class="o">::</span><span class="na">find</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]);</span>
</pre></div>
</div>
<p><strong>『找不到』抛出异常</strong></p>
<p>如果你希望在找不到模型时抛出异常，可以使用 <code class="docutils literal"><span class="pre">findOrFail</span></code> 以及 <code class="docutils literal"><span class="pre">firstOrFail</span></code> 方法。这些方法会检索查询的第一个结果，如果没有找到相应的结果，就会抛出一个 <code class="docutils literal"><span class="pre">Illuminate\Database\Eloquent\ModelNotFoundException</span></code> ：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$model</span> <span class="o">=</span> <span class="nx">App\Flight</span><span class="o">::</span><span class="na">findOrFail</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nv">$model</span> <span class="o">=</span> <span class="nx">App\Flight</span><span class="o">::</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;legs&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">firstOrFail</span><span class="p">();</span>
</pre></div>
</div>
<p>如果没有对异常进行捕获，则会自动返回 <code class="docutils literal"><span class="pre">404</span></code> 响应给用户。也就是说，在使用这些方法时，不需要另外写个检查来返回 <code class="docutils literal"><span class="pre">404</span></code> 响应：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/api/flights/{id}&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">App\Flight</span><span class="o">::</span><span class="na">findOrFail</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p class="last">一般用于 controller，在未找到记录的时候会抛出异常。</p>
</div>
<div class="section" id="id13">
<h3>60.4.1. 检索聚合<a class="headerlink" href="#id13" title="永久链接至标题">¶</a></h3>
<p>你还可以使用 查询构造器 提供的 <code class="docutils literal"><span class="pre">count</span></code> 、 <code class="docutils literal"><span class="pre">sum</span></code> 、 <code class="docutils literal"><span class="pre">max</span></code> 以及其它 聚合函数 。这些方法只会返回适当的标量值而不是整个模型实例：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$count</span> <span class="o">=</span> <span class="nx">App\Flight</span><span class="o">::</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">();</span>

<span class="nv">$max</span> <span class="o">=</span> <span class="nx">App\Flight</span><span class="o">::</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">max</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id14">
<h2>60.5. 插入 &amp; 更新模型<a class="headerlink" href="#id14" title="永久链接至标题">¶</a></h2>
<div class="section" id="id15">
<h3>60.5.1. 插入<a class="headerlink" href="#id15" title="永久链接至标题">¶</a></h3>
<p>要向数据库插入一条记录，先创建模型实例，再设置实例属性，然后调用 <code class="docutils literal"><span class="pre">save</span></code> 方法：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App\Http\Controllers</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Flight</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Http\Controllers\Controller</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">FlightController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 创建航班实例</span>
<span class="sd">     *</span>
<span class="sd">     * @param  Request  $request</span>
<span class="sd">     * @return Response</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">store</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 表单验证</span>

        <span class="nv">$flight</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Flight</span><span class="p">;</span>

        <span class="nv">$flight</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>

        <span class="nv">$flight</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>这个例子中， HTTP 请求的参数 <code class="docutils literal"><span class="pre">name</span></code> 赋值给了 <code class="docutils literal"><span class="pre">App\Flight</span></code> 模型实例的 <code class="docutils literal"><span class="pre">name</span></code> 属性。调用 <code class="docutils literal"><span class="pre">save</span></code> 方法，一条记录就会插入数据库。 <code class="docutils literal"><span class="pre">created_at</span></code> 和 <code class="docutils literal"><span class="pre">updated_at</span></code> 时间戳随着 <code class="docutils literal"><span class="pre">save</span></code> 方法的调用，会自动维护，无需手动操作。</p>
</div>
<div class="section" id="id16">
<h3>60.5.2. 更新<a class="headerlink" href="#id16" title="永久链接至标题">¶</a></h3>
<p>更新模型也会分为两种，一种是针对 Eloquent Model 的更新，这种更新必须是从数据库中取出的对象。还有一种是 Eloquent Builder 的更新，这种更新一般会带有多个查询条件。</p>
<p><code class="docutils literal"><span class="pre">save</span></code> 方法也可用于模型更新。更新模型时，需要检索到它，然后设置模型属性，再调用 <code class="docutils literal"><span class="pre">save</span></code> 方法。同样地， <code class="docutils literal"><span class="pre">updated_at</span></code> 时间戳自动更新，无需手动操作：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$flight</span> <span class="o">=</span> <span class="nx">App\Flight</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nv">$flight</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="s1">&#39;New Flight Name&#39;</span><span class="p">;</span>

<span class="nv">$flight</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p class="last">这里同样可以调用 <code class="docutils literal"><span class="pre">update()</span></code> 方法。 <code class="docutils literal"><span class="pre">save</span></code> 函数仅仅支持手动的属性赋值，无法批量赋值。</p>
</div>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$flight</span> <span class="o">=</span> <span class="nx">App\Flight</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nv">$flight</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">([</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;New Flight Name&#39;</span><span class="p">,</span><span class="s1">&#39;desc&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;test&#39;</span><span class="p">]);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p class="last">这里调用的是模型 update 方法，该方法不会使用全局作用域。</p>
</div>
<div class="section" id="id17">
<h4>60.5.2.1. 批量更新<a class="headerlink" href="#id17" title="永久链接至标题">¶</a></h4>
<p>也可一并更新查询到的多个模型。这个例子中，所有 <code class="docutils literal"><span class="pre">active</span></code> 和 <code class="docutils literal"><span class="pre">destination</span></code> 为 <code class="docutils literal"><span class="pre">San</span> <span class="pre">Diego</span></code> 的航班都被更新为延误：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nx">App\Flight</span><span class="o">::</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
          <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;destination&#39;</span><span class="p">,</span> <span class="s1">&#39;San Diego&#39;</span><span class="p">)</span>
          <span class="o">-&gt;</span><span class="na">update</span><span class="p">([</span><span class="s1">&#39;delayed&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">]);</span> <span class="c1">// 区别不在于使用静态调用，而是where方法返回构建器对象</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">update</span></code> 方法接受一个字段为键、更新数据为值的数组。</p>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p class="last"><code class="docutils literal"><span class="pre">Eloquent</span></code> 的批量更新不会触发 <code class="docutils literal"><span class="pre">saved</span></code> 和 <code class="docutils literal"><span class="pre">updated</span></code> 事件。这是因为批量更新时，从不去检索模型。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p class="last">这里调用的是构建器的 <code class="docutils literal"><span class="pre">update</span></code> 方法，该方法会使用全局作用域。模型和构建器中两个 <code class="docutils literal"><span class="pre">update</span></code> 功能一致，只是 <code class="docutils literal"><span class="pre">Model</span></code> 的 <code class="docutils literal"><span class="pre">update</span></code> 函数比较适用于更新从数据库取回的数据库对象。</p>
</div>
</div>
</div>
<div class="section" id="id18">
<h3>60.5.3. 批量赋值<a class="headerlink" href="#id18" title="永久链接至标题">¶</a></h3>
<p>你也可以使用 <code class="docutils literal"><span class="pre">create</span></code> 方法来保存新模型， 方法会返回模型实例。不过，在使用之前，你需要先在模型上指定 <code class="docutils literal"><span class="pre">fillable</span></code> 或 <code class="docutils literal"><span class="pre">guarded</span></code> 属性，因为所有的 <code class="docutils literal"><span class="pre">Eloquent</span></code> 模型在默认情况下都不能进行批量赋值。</p>
<p>当用户通过 <code class="docutils literal"><span class="pre">HTTP</span></code> 请求传入了一个意外参数，并且该参数更改了数据库中你不需要更改的字段时，就会发生批量赋值漏洞。例如，恶意用户可能会通过 <code class="docutils literal"><span class="pre">HTTP</span></code> 请求发送 <code class="docutils literal"><span class="pre">is_admin</span></code> 参数，然后将其传递给模型的 <code class="docutils literal"><span class="pre">create</span></code> 方法，此操作能让该用户把自己升级为管理者。</p>
<p>所以，在开始之前，你应该定义好哪些模型属性是可以被批量赋值的。你可以使用模型上的 <code class="docutils literal"><span class="pre">$fillable</span></code> 属性来实现。例如，让 <code class="docutils literal"><span class="pre">Flight</span></code> 模型的 <code class="docutils literal"><span class="pre">name</span></code> 属性可以被批量赋值：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Flight</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 可以被批量赋值的属性。</span>
<span class="sd">     *</span>
<span class="sd">     * @var array</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$fillable</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>当我们设置好批量赋值的属性，就可以通过 <code class="docutils literal"><span class="pre">create</span></code> 方法插入新数据。 <code class="docutils literal"><span class="pre">create</span></code> 方法将返回已保存的模型实例：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$flight</span> <span class="o">=</span> <span class="nx">App\Flight</span><span class="o">::</span><span class="na">create</span><span class="p">([</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Flight 10&#39;</span><span class="p">]);</span>
</pre></div>
</div>
<p>如果你已经有一个模型实例，你可以传递数组给 <code class="docutils literal"><span class="pre">fill</span></code> 方法来赋值：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$flight</span><span class="o">-&gt;</span><span class="na">fill</span><span class="p">([</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Flight 22&#39;</span><span class="p">]);</span>
</pre></div>
</div>
<div class="section" id="forcefill">
<h4>60.5.3.1. forceFill<a class="headerlink" href="#forcefill" title="永久链接至标题">¶</a></h4>
<p>如果不想受 <code class="docutils literal"><span class="pre">fillable</span></code> 或者 <code class="docutils literal"><span class="pre">guarded</span></code> 等的影响，还可以使用 <code class="docutils literal"><span class="pre">forceFill</span></code> 强制来批量赋值。</p>
</div>
<div class="section" id="id19">
<h4>60.5.3.2. 保护属性<a class="headerlink" href="#id19" title="永久链接至标题">¶</a></h4>
<p><code class="docutils literal"><span class="pre">$fillable</span></code> 可以作为批量赋值的『白名单』，你也可以使用 <code class="docutils literal"><span class="pre">$guarded</span></code> 属性来实现。不同的是， <code class="docutils literal"><span class="pre">$guarded</span></code> 属性包含的是不允许被批量赋值的数组。 也就是说， <code class="docutils literal"><span class="pre">$guarded</span></code> 从功能上讲更像是一个『黑名单』。注意，在使用上，只能是 <code class="docutils literal"><span class="pre">$fillable</span></code> 或 <code class="docutils literal"><span class="pre">$guarded</span></code> 二选一。 下面这个例子中，除了 <code class="docutils literal"><span class="pre">price</span></code> 所有的属性都可以被批量赋值：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Flight</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 不可被批量赋值的属性。</span>
<span class="sd">     *</span>
<span class="sd">     * @var array</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$guarded</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>将 <code class="docutils literal"><span class="pre">$guarded</span></code> 定义为空数组，则所有属性都可以被批量赋值</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * 不可被批量赋值的属性。</span>
<span class="sd"> *</span>
<span class="sd"> * @var array</span>
<span class="sd"> */</span>
<span class="k">protected</span> <span class="nv">$guarded</span> <span class="o">=</span> <span class="p">[];</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id20">
<h3>60.5.4. 其它创建方法<a class="headerlink" href="#id20" title="永久链接至标题">¶</a></h3>
<div class="section" id="firstorcreate-firstornew">
<h4>60.5.4.1. firstOrCreate/ firstOrNew<a class="headerlink" href="#firstorcreate-firstornew" title="永久链接至标题">¶</a></h4>
<p>这里有两个可能被用的别的方法，你可以通过批量分配属性来创建模型： <code class="docutils literal"><span class="pre">firstOrCreate</span></code> 和 <code class="docutils literal"><span class="pre">firstOrNew</span></code> 。 <code class="docutils literal"><span class="pre">firstOrCreate</span></code> 方法将尝试使用给定的列/值来查找数据库。如果在数据库找不到该模型，则会从第一个参数的属性加上第二个参数的属性中创建一条记录插入到数据库。</p>
<p><code class="docutils literal"><span class="pre">firstOrNew</span></code> 方法像 <code class="docutils literal"><span class="pre">firstOrCreate</span></code> 方法一样将尝试在与给定属性相匹配的数据库中查找记录。不同的是，如果未找到模型，则会返回一个新的模型实例。注意 <code class="docutils literal"><span class="pre">firstOrNew</span></code> 返回的模型尚未被保存到数据库中。你需要手动调用 <code class="docutils literal"><span class="pre">save</span></code> 方法保存：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// 通过 name 查找航班，不存在则创建...</span>
<span class="nv">$flight</span> <span class="o">=</span> <span class="nx">App\Flight</span><span class="o">::</span><span class="na">firstOrCreate</span><span class="p">([</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Flight 10&#39;</span><span class="p">]);</span>

<span class="c1">// 通过 name 查找航班，不存在则使用 name 和 delayed 属性创建...</span>
<span class="nv">$flight</span> <span class="o">=</span> <span class="nx">App\Flight</span><span class="o">::</span><span class="na">firstOrCreate</span><span class="p">(</span>
    <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Flight 10&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;delayed&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">]</span>
<span class="p">);</span>

<span class="c1">// 通过 name 查找航班，不存在则创建一个实例...</span>
<span class="nv">$flight</span> <span class="o">=</span> <span class="nx">App\Flight</span><span class="o">::</span><span class="na">firstOrNew</span><span class="p">([</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Flight 10&#39;</span><span class="p">]);</span>

<span class="c1">// 通过 name 查找航班，不存在则使用 name 和 delayed 属性创建一个实例...</span>
<span class="nv">$flight</span> <span class="o">=</span> <span class="nx">App\Flight</span><span class="o">::</span><span class="na">firstOrNew</span><span class="p">(</span>
    <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Flight 10&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;delayed&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">]</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="updateorcreate">
<h4>60.5.4.2. updateOrCreate<a class="headerlink" href="#updateorcreate" title="永久链接至标题">¶</a></h4>
<p>你还可能遇到希望更新现有模型或在不存在的情况下则创建新的模型的情景。Laravel 提供了 <code class="docutils literal"><span class="pre">updateOrCreate</span></code> 方法仅一个步骤就可以实现。 跟 <code class="docutils literal"><span class="pre">firstOrCreate</span></code> 方法一样, <code class="docutils literal"><span class="pre">updateOrCreate</span></code> 模型存在，所以不需要调用 <code class="docutils literal"><span class="pre">save()</span></code> 方法：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// 如果有从奥克兰到圣地亚哥的航班，则价格定为99美元。</span>
<span class="c1">// 如果没匹配到存在的模型，则使用提供的第一个和第二个参数合并创建一个。</span>
<span class="nv">$flight</span> <span class="o">=</span> <span class="nx">App\Flight</span><span class="o">::</span><span class="na">updateOrCreate</span><span class="p">(</span>
    <span class="p">[</span><span class="s1">&#39;departure&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Oakland&#39;</span><span class="p">,</span> <span class="s1">&#39;destination&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;San Diego&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;price&#39;</span> <span class="o">=&gt;</span> <span class="mi">99</span><span class="p">]</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id21">
<h2>60.6. 删除模型<a class="headerlink" href="#id21" title="永久链接至标题">¶</a></h2>
<p>删除模型也会分为两种，一种是针对 Eloquent Model 的删除，这种删除必须是从数据库中取出的对象。还有一种是 Eloquent Builder 的删除，这种删除一般会带有多个查询条件。我们这一小节主要讲 <code class="docutils literal"><span class="pre">model</span></code> 的删除：</p>
<p>可以在模型示例上调用 <code class="docutils literal"><span class="pre">delete</span></code> 方法来删除模型：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$flight</span> <span class="o">=</span> <span class="nx">App\Flight</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nv">$flight</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">();</span>
</pre></div>
</div>
<div class="section" id="id22">
<h3>60.6.1. 通过主键删除模型<a class="headerlink" href="#id22" title="永久链接至标题">¶</a></h3>
<p>在上面的例子中，在调用 <code class="docutils literal"><span class="pre">delete</span></code> 方法之前先从数据库中检索模型。然而，如果你已经知道了这个模型的主键，则可以删除模型而不检索它。此时，可以调用 <code class="docutils literal"><span class="pre">destroy</span></code> 方法：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nx">App\Flight</span><span class="o">::</span><span class="na">destroy</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nx">App\Flight</span><span class="o">::</span><span class="na">destroy</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]);</span>

<span class="nx">App\Flight</span><span class="o">::</span><span class="na">destroy</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="id23">
<h3>60.6.2. 通过查询删除模型<a class="headerlink" href="#id23" title="永久链接至标题">¶</a></h3>
<p>当然，你也可以在模型上运行删除语句。在这个例子中，我们将删除所有标记为非活跃的航班。与批量更新一样，批量删除不会为删除的模型启动任何模型事件：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$deletedRows</span> <span class="o">=</span> <span class="nx">App\Flight</span><span class="o">::</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">();</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p class="last">通过 <code class="docutils literal"><span class="pre">Eloquent</span></code> 执行批量删除语句时，不会触发 <code class="docutils literal"><span class="pre">deleting</span></code> 和 <code class="docutils literal"><span class="pre">deleted</span></code> 模型事件。因为在执行删除语句时，从不检索模型示例。</p>
</div>
</div>
<div class="section" id="id24">
<h3>60.6.3. 软删除<a class="headerlink" href="#id24" title="永久链接至标题">¶</a></h3>
<p>除了真实删除数据库的记录， <code class="docutils literal"><span class="pre">Eloquent</span></code> 也可以「软删除」模型。软删除的模型并不是真的从数据库里删除了。其实是，模型上设置了 <code class="docutils literal"><span class="pre">deleted_at</span></code> 属性并把其值写入数据库。如果 <code class="docutils literal"><span class="pre">deleted_at</span></code> 值非空，代表已软删除这个模型。要开启模型的软删除功能，可以在模型上使用 <code class="docutils literal"><span class="pre">Illuminate\Database\Eloquent\SoftDeletes</span></code> trait 并把 <code class="docutils literal"><span class="pre">deleted_at</span></code> 字段加入 <code class="docutils literal"><span class="pre">$dates</span></code> 属性：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\SoftDeletes</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Flight</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nx">SoftDeletes</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * 需要转换成日期的属性</span>
<span class="sd">     *</span>
<span class="sd">     * @var array</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$dates</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;deleted_at&#39;</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>当然，需要把 <code class="docutils literal"><span class="pre">deleted_at</span></code> 字段加到数据库表。 Laravel 的 表结构构造器 提供了一个辅助方法来生成这个字段：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nx">Schema</span><span class="o">::</span><span class="na">table</span><span class="p">(</span><span class="s1">&#39;flights&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$table</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">softDeletes</span><span class="p">();</span>
<span class="p">});</span>
</pre></div>
</div>
<p>现在，模型调用 <code class="docutils literal"><span class="pre">delete</span></code> 方法，当前日期时间会写入 <code class="docutils literal"><span class="pre">deleted_at</span></code> 字段。同时，查询出来的结果也会自动剔除软删除的模型。</p>
<p>使用 <code class="docutils literal"><span class="pre">trashed</span></code> 方法验证当前模型是否软删除：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$flight</span><span class="o">-&gt;</span><span class="na">trashed</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">//</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="id25">
<h4>60.6.3.1. 查询软删除模型<a class="headerlink" href="#id25" title="永久链接至标题">¶</a></h4>
<div class="section" id="id26">
<h5>60.6.3.1.1. 包括软删除的模型<a class="headerlink" href="#id26" title="永久链接至标题">¶</a></h5>
<p>前边已经提到，查询结果会自动剔除软删除模型。然而，查询中可以使用 <code class="docutils literal"><span class="pre">withTrashed</span></code> 方法获取包括软删除在内的模型：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$flights</span> <span class="o">=</span> <span class="nx">App\Flight</span><span class="o">::</span><span class="na">withTrashed</span><span class="p">()</span>
                <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;account_id&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">withTrashed</span></code> 方法也可以用在 关联 查询：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$flight</span><span class="o">-&gt;</span><span class="na">history</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">withTrashed</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="id27">
<h5>60.6.3.1.2. 只检索软删除模型<a class="headerlink" href="#id27" title="永久链接至标题">¶</a></h5>
<p><code class="docutils literal"><span class="pre">onlyTrashed</span></code> 方法只检索软删除的模型：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$flights</span> <span class="o">=</span> <span class="nx">App\Flight</span><span class="o">::</span><span class="na">onlyTrashed</span><span class="p">()</span>
                <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;airline_id&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="id28">
<h5>60.6.3.1.3. 恢复软删除模型<a class="headerlink" href="#id28" title="永久链接至标题">¶</a></h5>
<p>有时会对软删除模型进行「撤销」，在软删除模型实例上使用 <code class="docutils literal"><span class="pre">restore</span></code> 方法即可恢复到有效状态：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$flight</span><span class="o">-&gt;</span><span class="na">restore</span><span class="p">();</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">restore</span></code> 方法可在查询上使用，从而快速恢复多个模型。和其他「批量」操作一样，这个操作不会触发模型的任何事件：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nx">App\Flight</span><span class="o">::</span><span class="na">withTrashed</span><span class="p">()</span>
        <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;airline_id&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">restore</span><span class="p">();</span>
</pre></div>
</div>
<p>类似 <code class="docutils literal"><span class="pre">withTrashed</span></code> 方法，关联 也可使用 <code class="docutils literal"><span class="pre">restore</span></code> ：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$flight</span><span class="o">-&gt;</span><span class="na">history</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">restore</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="id29">
<h5>60.6.3.1.4. 永久删除<a class="headerlink" href="#id29" title="永久链接至标题">¶</a></h5>
<p>要真实删除数据时，使用 <code class="docutils literal"><span class="pre">forceDelete</span></code> 方法即可把软删除模型从数据里永久删除：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// 单个模型实例的永久删除</span>
<span class="nv">$flight</span><span class="o">-&gt;</span><span class="na">forceDelete</span><span class="p">();</span>

<span class="c1">// 关联模型的永久删除</span>
<span class="nv">$flight</span><span class="o">-&gt;</span><span class="na">history</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">forceDelete</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="id30">
<h2>60.7. 查询作用域<a class="headerlink" href="#id30" title="永久链接至标题">¶</a></h2>
<p>查询作用域分为全局作用域与本地作用域。全局作用域不需要手动调用，由程序在每次的查询中自动加载，本地作用域需要在查询的时候进行手动调用。</p>
<div class="section" id="id31">
<h3>60.7.1. 全局作用域<a class="headerlink" href="#id31" title="永久链接至标题">¶</a></h3>
<p>全局作用域可以给模型的查询都添加上约束。Laravel 的 软删除 功能就是利用了「未删除」的全局作用域。自定义全局作用域使用起来更方便、简单，同时保证了每一个模型的查询都受到特定约束。</p>
<div class="section" id="id32">
<h4>60.7.1.1. 编写全局作用域<a class="headerlink" href="#id32" title="永久链接至标题">¶</a></h4>
<p>编写全局作用域非常简单。定义一个实现 <code class="docutils literal"><span class="pre">Illuminate\Database\Eloquent\Scope</span></code> 接口的类，并实现 <code class="docutils literal"><span class="pre">apply</span></code> 这一方法。 根据需求，在 <code class="docutils literal"><span class="pre">apply</span></code> 加入查询的 <code class="docutils literal"><span class="pre">where</span></code> 约束：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App\Scopes</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Scope</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Builder</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AgeScope</span> <span class="k">implements</span> <span class="nx">Scope</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 把约束加到 Eloquent 查询构造中.</span>
<span class="sd">     *</span>
<span class="sd">     * @param  \Illuminate\Database\Eloquent\Builder  $builder</span>
<span class="sd">     * @param  \Illuminate\Database\Eloquent\Model  $model</span>
<span class="sd">     * @return void</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">apply</span><span class="p">(</span><span class="nx">Builder</span> <span class="nv">$builder</span><span class="p">,</span> <span class="nx">Model</span> <span class="nv">$model</span><span class="p">)</span> <span class="c1">// 会传入模型对象</span>
    <span class="p">{</span>
        <span class="nv">$builder</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">小技巧</p>
<p class="last">如果需要在 <code class="docutils literal"><span class="pre">select</span></code> 语句里添加字段，应使用 <code class="docutils literal"><span class="pre">addSelect</span></code> 方法，而不是 <code class="docutils literal"><span class="pre">select</span></code> 方法。 这将有效防止无意中替换现有 <code class="docutils literal"><span class="pre">select</span></code> 语句的情况。</p>
</div>
</div>
<div class="section" id="id33">
<h4>60.7.1.2. 应用全局作用域<a class="headerlink" href="#id33" title="永久链接至标题">¶</a></h4>
<p>重写 <code class="docutils literal"><span class="pre">boot</span></code> 方法并使用 <code class="docutils literal"><span class="pre">addGlobalScope</span></code> 方法即可应用全局作用域到模型：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Scopes\AgeScope</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 模型的「启动」方法</span>
<span class="sd">     *</span>
<span class="sd">     * @return void</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">boot</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">boot</span><span class="p">();</span>

        <span class="k">static</span><span class="o">::</span><span class="na">addGlobalScope</span><span class="p">(</span><span class="k">new</span> <span class="nx">AgeScope</span><span class="p">);</span> <span class="c1">// 注意，这里传入的是对象实例，默认使用类名称 AgeScope::class 作为作用域名称</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>添加作用域后， <code class="docutils literal"><span class="pre">User::all()</span></code> 的查询语句如下：</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="o">`</span><span class="n">users</span><span class="o">`</span> <span class="k">where</span> <span class="o">`</span><span class="n">age</span><span class="o">`</span> <span class="o">&gt;</span> <span class="mi">200</span>
</pre></div>
</div>
</div>
<div class="section" id="id34">
<h4>60.7.1.3. 匿名的全局作用域<a class="headerlink" href="#id34" title="永久链接至标题">¶</a></h4>
<p><code class="docutils literal"><span class="pre">Eloquent</span></code> 也可用闭包定义全局作用域，这样就不必要再为一个简单的作用域而编写一个完整的类：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Builder</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 模型的「启动」方法</span>
<span class="sd">     *</span>
<span class="sd">     * @return void</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">boot</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">boot</span><span class="p">();</span>
        <span class="c1">// 这里是命名全局作用域，可以通过指定名称取消</span>
        <span class="k">static</span><span class="o">::</span><span class="na">addGlobalScope</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Builder</span> <span class="nv">$builder</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$builder</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="c1">// 这才是匿名全局作用域，几乎不能取消</span>
        <span class="k">static</span><span class="o">::</span><span class="na">addGlobalScope</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">Builder</span> <span class="nv">$builder</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$builder</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id35">
<h4>60.7.1.4. 取消全局作用域<a class="headerlink" href="#id35" title="永久链接至标题">¶</a></h4>
<p>使用 <code class="docutils literal"><span class="pre">withoutGlobalScope</span></code> 方法可以取消当前查询的全局作用域。这个方法接受一个全局作用域的类名作为它唯一的参数：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nx">User</span><span class="o">::</span><span class="na">withoutGlobalScope</span><span class="p">(</span><span class="nx">AgeScope</span><span class="o">::</span><span class="na">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</pre></div>
</div>
<p>全局作用域是闭包的话：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nx">User</span><span class="o">::</span><span class="na">withoutGlobalScope</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">withoutGlobalScopes</span></code> 方法可以取消多个甚至全部的全局作用域：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">// 取消全部作用域</span>
<span class="nx">User</span><span class="o">::</span><span class="na">withoutGlobalScopes</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>

<span class="c1">// 取消个别全局作用域</span>
<span class="nx">User</span><span class="o">::</span><span class="na">withoutGlobalScopes</span><span class="p">([</span>
    <span class="nx">FirstScope</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="nx">SecondScope</span><span class="o">::</span><span class="na">class</span>
<span class="p">])</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id36">
<h3>60.7.2. 本地作用域<a class="headerlink" href="#id36" title="永久链接至标题">¶</a></h3>
<p>本地范围允许定义通用的约束集合以便在应用中复用。 例如， 你可能经常需要获取「受欢迎的」用户。要定义这样一个范围，只需要在对应的 <code class="docutils literal"><span class="pre">Eloquent</span></code> 模型方法前加入 <code class="docutils literal"><span class="pre">scope</span></code> 前缀。</p>
<p>作用域总是返回一个查询构造器实例：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 只查询受欢迎的用户.</span>
<span class="sd">     *</span>
<span class="sd">     * @param \Illuminate\Database\Eloquent\Builder $query</span>
<span class="sd">     * @return \Illuminate\Database\Eloquent\Builder</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">scopePopular</span><span class="p">(</span><span class="nv">$query</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;votes&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * 只查询 active 的用户.</span>
<span class="sd">     *</span>
<span class="sd">     * @param \Illuminate\Database\Eloquent\Builder $query</span>
<span class="sd">     * @return \Illuminate\Database\Eloquent\Builder</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">scopeActive</span><span class="p">(</span><span class="nv">$query</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="id37">
<h4>60.7.2.1. 使用本地作用域<a class="headerlink" href="#id37" title="永久链接至标题">¶</a></h4>
<p>一旦定义作用域。就可以在模型查询的时候调用作用域方法。在方法调用时你不需要添加 <code class="docutils literal"><span class="pre">scope</span></code> 前缀。你甚至可以链式调用不同的作用域范围, 例如：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$users</span> <span class="o">=</span> <span class="nx">App\User</span><span class="o">::</span><span class="na">popular</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">active</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">orderBy</span><span class="p">(</span><span class="s1">&#39;created_at&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id38">
<h3>60.7.3. 动态作用域(全局作用域可以传入参数么？？)<a class="headerlink" href="#id38" title="永久链接至标题">¶</a></h3>
<p>有时，你可能希望定义一个可接受参数的范围。这时只需给你的范围添加额外的参数即可。 范围参数应该定义在 <code class="docutils literal"><span class="pre">$query</span></code> 参数后：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 查询只包含特定类型的用户.</span>
<span class="sd">     *</span>
<span class="sd">     * @param \Illuminate\Database\Eloquent\Builder $query</span>
<span class="sd">     * @param mixed $type</span>
<span class="sd">     * @return \Illuminate\Database\Eloquent\Builder</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">scopeOfType</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$type</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="nv">$type</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>现在，你可以在调用作用域时传递参数：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$users</span> <span class="o">=</span> <span class="nx">App\User</span><span class="o">::</span><span class="na">ofType</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id39">
<h2>60.8. 事件<a class="headerlink" href="#id39" title="永久链接至标题">¶</a></h2>
<p><code class="docutils literal"><span class="pre">Eloquent</span></code> 模型会触发许多事件，让你在模型的生命周期的多个时间点进行监控： <code class="docutils literal"><span class="pre">retrieved</span></code> , <code class="docutils literal"><span class="pre">creating</span></code> , <code class="docutils literal"><span class="pre">created</span></code> , <code class="docutils literal"><span class="pre">updating</span></code> , <code class="docutils literal"><span class="pre">updated</span></code> , <code class="docutils literal"><span class="pre">saving</span></code> , <code class="docutils literal"><span class="pre">saved</span></code> , <code class="docutils literal"><span class="pre">deleting</span></code> , <code class="docutils literal"><span class="pre">deleted</span></code> , <code class="docutils literal"><span class="pre">restoring</span></code> , <code class="docutils literal"><span class="pre">restored</span></code> 。 事件让你在每当有特定模型类进行数据库保存或更新时，执行代码。</p>
<p>当从数据库检索现有模型时，会触发 <code class="docutils literal"><span class="pre">retrieved</span></code> 事件。当模型第一次被保存时， <code class="docutils literal"><span class="pre">creating</span></code> 和 <code class="docutils literal"><span class="pre">created</span></code> 事件会被触发。若数据库中已存在此模型，并调用 <code class="docutils literal"><span class="pre">save</span></code> 方法， <code class="docutils literal"><span class="pre">updating</span> <span class="pre">/</span> <span class="pre">updated</span></code> 事件会被触发。 这两种情况下， <code class="docutils literal"><span class="pre">saving</span> <span class="pre">/</span> <span class="pre">saved</span></code> 事件都会被触发。</p>
<p>开始前，先在你的 <code class="docutils literal"><span class="pre">Eloquent</span></code> 模型上定义一个 <code class="docutils literal"><span class="pre">$dispatchesEvents</span></code> 属性，将 <code class="docutils literal"><span class="pre">Eloquent</span></code> 模型的生命周期的多个点映射到你的 事件类：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Events\UserSaved</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Events\UserDeleted</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Notifications\Notifiable</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Foundation\Auth\User</span> <span class="k">as</span> <span class="nx">Authenticatable</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">Authenticatable</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nx">Notifiable</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * 此模型的事件映射.</span>
<span class="sd">     *</span>
<span class="sd">     * @var array</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$dispatchesEvents</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;saved&#39;</span> <span class="o">=&gt;</span> <span class="nx">UserSaved</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
        <span class="s1">&#39;deleted&#39;</span> <span class="o">=&gt;</span> <span class="nx">UserDeleted</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
    <span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="id40">
<h3>60.8.1. 观察者<a class="headerlink" href="#id40" title="永久链接至标题">¶</a></h3>
<p>如果你在一个给定模型中监听许多事件，你可以使用观察者将所有的监听添加到一个类。观察者类里的方法名应该反映 <code class="docutils literal"><span class="pre">Eloquent</span></code> 想监听的事件。 每个方法接受 <code class="docutils literal"><span class="pre">model</span></code> 作为唯一参数。 Laravel 不包含观察者的默认目录，所以你可以创建任何你喜欢的目录来存放观察者类：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App\Observers</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\User</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserObserver</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 监听创建用户事件.</span>
<span class="sd">     *</span>
<span class="sd">     * @param  \App\User  $user</span>
<span class="sd">     * @return void</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">created</span><span class="p">(</span><span class="nx">User</span> <span class="nv">$user</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * 监听删除用户事件.</span>
<span class="sd">     *</span>
<span class="sd">     * @param  \App\User  $user</span>
<span class="sd">     * @return void</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">deleting</span><span class="p">(</span><span class="nx">User</span> <span class="nv">$user</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p class="last">观察者里面的方法命名是否有规定？？？</p>
</div>
<p>要注册一个观察者，需要用模型中的 <code class="docutils literal"><span class="pre">observe</span></code> 方法去观察。 你可以在你得服务提供者之一的 <code class="docutils literal"><span class="pre">boot</span></code> 方法中注册观察者。在这个例子中，我们将在 <code class="docutils literal"><span class="pre">AppServiceProvider</span></code> 中注册观察者：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App\Providers</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\User</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Observers\UserObserver</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Support\ServiceProvider</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AppServiceProvider</span> <span class="k">extends</span> <span class="nx">ServiceProvider</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 运行所有应用服务.</span>
<span class="sd">     *</span>
<span class="sd">     * @return void</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">boot</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nx">User</span><span class="o">::</span><span class="na">observe</span><span class="p">(</span><span class="nx">UserObserver</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * 注册服务提供.</span>
<span class="sd">     *</span>
<span class="sd">     * @return void</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">register</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Laravel的数据库—Eloquent关联.html" class="btn btn-neutral float-right" title="61. Eloquent关联" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Laravel的Redis原理分析.html" class="btn btn-neutral" title="59. Redis原理分析" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, lzh.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.0',
            LANGUAGE:'zh',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  

<script type="text/javascript">
  
      $(document).ready(function(){
        var offset = sessionStorage.getItem("offsetTop");
        $('.wy-side-scroll').scrollTop(offset);
        sessionStorage.setItem("offsetTop", 0);


        $('.wy-menu > ul').click(function(){
            sessionStorage.setItem("offsetTop", $('.wy-side-scroll').scrollTop());
        });
      })

  </script> 

</body>
</html>