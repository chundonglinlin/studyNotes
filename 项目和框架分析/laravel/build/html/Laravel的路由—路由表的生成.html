

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>路由表的生成 &mdash; laravel 1.0 文档</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="索引"
              href="genindex.html"/>
        <link rel="search" title="搜索" href="search.html"/>
    <link rel="top" title="laravel 1.0 文档" href="index.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> laravel
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">目录:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="请求到响应的生命周期-web.html">1. 请求到web响应的生命周期</a></li>
<li class="toctree-l1"><a class="reference internal" href="请求到响应的生命周期-console.html">2. 请求到console响应的生命周期</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的容器.html">3. 容器</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Facades.html">4. Facades</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Facades原理分析.html">5. Facade的原理</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的服务提供器.html">6. 服务提供器</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的路由.html">7. 路由</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的路由—路由的正则编译.html">8. 路由的正则编译</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的路由—路由的匹配与参数绑定.html">9. 路由的匹配与参数绑定</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的路由—路由中间件.html">10. 路由的中间件</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的中间件.html">11. 中间件</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的中间件-SubstituteBindings.html">12. 中间件SubstituteBindings</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的中间件-CSRF.html">13. 中间件CSRF</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的请求.html">14. 请求</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的控制器.html">15. 控制器</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的控制器—控制器方法的参数构建与运行.html">16. 控制器方法的参数构建与运行</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的响应.html">17. 响应</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的视图.html">18. 视图</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的生成URL.html">19. URL</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Session.html">20. Session</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Session原理分析.html">21. Session原理分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的表单验证机制详解.html">22. 表单验证机制详解</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的日志.html">23. 日志</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的异常和错误处理.html">24. 异常和错误处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的异常和错误处理原理分析.html">25. 异常和错误处理原理分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Blade.html">26. Blade</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的blade原理分析.html">27. Blade原理分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的前端.html">28. 前端</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Mix.html">29. Mix</a></li>
<li class="toctree-l1"><a class="reference internal" href="laravel-mix.html">30. mix使用手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的用户认证系统.html">31. Laravel 的用户认证系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="用户认证JWT.html">32. 用户认证JWT</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的API认证系统Passport.html">33. Laravel 的 API 认证系统 Passport</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的用户授权系统.html">34. Laravel用户授权系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的命令行.html">35. 命令行</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的广播系统.html">36. 广播</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的广播系统原理分析.html">37. 广播系统原理分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的缓存系统.html">38. 缓存</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的集合Collection.html">39. 集合</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的事件系统.html">40. 事件</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的事件系统原理分析.html">41. 事件系统原理分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的文件存储.html">42. 文件存储</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的辅助函数-字符串操作.html">43. 辅助函数-字符串函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的辅助函数-数组和对象操作.html">44. 辅助函数-数组和对象函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的辅助函数-路径操作.html">45. 辅助函数-路径函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的辅助函数-tap分析.html">46. 辅助函数-Tap函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的辅助函数-其它.html">47. 辅助函数-其它杂项</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的邮件发送功能.html">48. 邮件</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的消息通知.html">49. 通知</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel Queue——消息队列任务与分发源码剖析.html">50. 消息队列任务与分发源码剖析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的任务调度.html">51. 任务调度</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据库—原始方式.html">52. 数据库-原始操作</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据库—查询构造器.html">53. 数据库-查询构建器</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据分页.html">54. 数据分页</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据分页原理分析.html">55. 数据分页原理分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据库迁移.html">56. 数据库迁移</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据库填充.html">57. 数据库填充</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Redis.html">58. Redis</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Redis原理分析.html">59. Redis原理分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据库—Eloquent.html">60. Eloquent</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据库—Eloquent关联.html">61. Eloquent关联</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据库—Eloquent修改器.html">62. Eloquent修改器</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的验证规则.html">63. 验证规则</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">laravel</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>路由表的生成</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
        
        <a href="http://blog.liaozhonghao.cn" rel="nofollow"> 返回主页</a>
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>路由表的生成<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<div class="section" id="id2">
<h2>前言<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>作为 laravel 极其重要的一部分， <code class="docutils literal"><span class="pre">route</span></code> 功能贯穿着整个网络请求，是 <code class="docutils literal"><span class="pre">request</span></code> 生命周期的主干。本文主要讲述 <code class="docutils literal"><span class="pre">route</span></code> 服务的注册与启动、路由的属性注册。本篇内容相对简单，更多的是框架添加路由的整体设计流程。</p>
</div>
<div class="section" id="route">
<h2>route 服务的注册<a class="headerlink" href="#route" title="永久链接至标题">¶</a></h2>
<p>laravel 在接受到请求后，先进行了服务容器与 <code class="docutils literal"><span class="pre">http</span></code> 核心的初始化，再进行了请求 <code class="docutils literal"><span class="pre">request</span></code> 的构造与分发。</p>
<p><code class="docutils literal"><span class="pre">route</span></code> 服务的注册—— <code class="docutils literal"><span class="pre">RoutingServiceProvider</span></code> 发生在服务容器 <code class="docutils literal"><span class="pre">container</span></code> 的初始化上;</p>
<p><code class="docutils literal"><span class="pre">route</span></code> 服务的启动与加载—— <code class="docutils literal"><span class="pre">RouteServiceProvider</span></code> 发生在 <code class="docutils literal"><span class="pre">request</span></code> 的分发上。</p>
<div class="section" id="route-routingserviceprovider">
<h3>route 服务的注册——RoutingServiceProvider<a class="headerlink" href="#route-routingserviceprovider" title="永久链接至标题">¶</a></h3>
<p>所有需要 laravel 服务的请求都会加载入口文件 <code class="docutils literal"><span class="pre">index.php</span></code> :</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">require</span> <span class="no">__DIR__</span><span class="o">.</span><span class="s1">&#39;/../bootstrap/autoload.php&#39;</span><span class="p">;</span>

<span class="nv">$app</span> <span class="o">=</span> <span class="k">require_once</span> <span class="no">__DIR__</span><span class="o">.</span><span class="s1">&#39;/../bootstrap/app.php&#39;</span><span class="p">;</span>
</pre></div>
</div>
<p>第一句我们在之前的博客提过，是实现 <code class="docutils literal"><span class="pre">PSR0</span></code>  、 <code class="docutils literal"><span class="pre">PSR4</span></code> 标准自动加载的功能模块，第二句就是今天说的 <code class="docutils literal"><span class="pre">container</span></code> 的初始化：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Illuminate\Foundation\Application</span><span class="p">(</span>
    <span class="nb">realpath</span><span class="p">(</span><span class="no">__DIR__</span><span class="o">.</span><span class="s1">&#39;/../&#39;</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">class</span> <span class="nc">Application</span> <span class="k">extends</span> <span class="nx">Container</span> <span class="k">implements</span> <span class="nx">ApplicationContract</span><span class="p">,</span> <span class="nx">HttpKernelInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$basePath</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$basePath</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setBasePath</span><span class="p">(</span><span class="nv">$basePath</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">registerBaseBindings</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">registerBaseServiceProviders</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">registerCoreContainerAliases</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>路由服务的注册就在 <code class="docutils literal"><span class="pre">registerBaseServiceProviders()</span></code> 这个函数中：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">protected</span> <span class="k">function</span> <span class="nf">registerBaseServiceProviders</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="k">new</span> <span class="nx">EventServiceProvider</span><span class="p">(</span><span class="nv">$this</span><span class="p">));</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="k">new</span> <span class="nx">LogServiceProvider</span><span class="p">(</span><span class="nv">$this</span><span class="p">));</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="k">new</span> <span class="nx">RoutingServiceProvider</span><span class="p">(</span><span class="nv">$this</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">RoutingServiceProvider</span> <span class="k">extends</span> <span class="nx">ServiceProvider</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">register</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">registerRouter</span><span class="p">();</span>

        <span class="o">...</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">registerRouter</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="o">-&gt;</span><span class="na">singleton</span><span class="p">(</span><span class="s1">&#39;router&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$app</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">Router</span><span class="p">(</span><span class="nv">$app</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">],</span> <span class="nv">$app</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="o">...</span>

<span class="p">}</span>
</pre></div>
</div>
<p>可以看到， <code class="docutils literal"><span class="pre">RoutingServiceProvider</span></code> 做的事情比较简单，就是向服务容易中注册 <code class="docutils literal"><span class="pre">router</span></code> 。</p>
</div>
<div class="section" id="route-routeserviceprovider">
<h3>route 服务的启动与加载——RouteServiceProvider<a class="headerlink" href="#route-routeserviceprovider" title="永久链接至标题">¶</a></h3>
<p>laravel 在初始化 <code class="docutils literal"><span class="pre">Application</span></code> 后，就要进行 <code class="docutils literal"><span class="pre">http/Kernel</span></code> 的构造：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$kernel</span> <span class="o">=</span> <span class="nv">$app</span><span class="o">-&gt;</span><span class="na">make</span><span class="p">(</span><span class="nx">Illuminate\Contracts\Http\Kernel</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

<span class="nv">$response</span> <span class="o">=</span> <span class="nv">$kernel</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span>
    <span class="nv">$request</span> <span class="o">=</span> <span class="nx">Illuminate\Http\Request</span><span class="o">::</span><span class="na">capture</span><span class="p">()</span>
<span class="p">);</span>
</pre></div>
</div>
<p>初始化结束后，就会调用 <code class="docutils literal"><span class="pre">handle</span></code> 函数，这个函数用于 laravel 各个功能服务的注册启动，还有 <code class="docutils literal"><span class="pre">request</span></code> 的分发：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nv">$request</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">enableHttpMethodParameterOverride</span><span class="p">();</span>

        <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sendRequestThroughRouter</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">protected</span> <span class="k">function</span> <span class="nf">sendRequestThroughRouter</span><span class="p">(</span><span class="nv">$request</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="o">-&gt;</span><span class="na">instance</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="nv">$request</span><span class="p">);</span>

    <span class="nx">Facade</span><span class="o">::</span><span class="na">clearResolvedInstance</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">bootstrap</span><span class="p">();</span><span class="c1">//各种服务的注册与启动</span>

    <span class="k">return</span> <span class="p">(</span><span class="k">new</span> <span class="nx">Pipeline</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="p">))</span><span class="c1">//请求的分发</span>
                <span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nv">$request</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">through</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="o">-&gt;</span><span class="na">shouldSkipMiddleware</span><span class="p">()</span> <span class="o">?</span> <span class="p">[]</span> <span class="o">:</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">then</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dispatchToRouter</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<p>路由服务的启动与加载就在其中一个函数中 <code class="docutils literal"><span class="pre">bootstrap</span></code> ，这个函数用于各种服务的注册与启动，比较复杂，我们有机会在以后单独来说。</p>
<p>总之，这个函数会调用 <code class="docutils literal"><span class="pre">RouteServiceProvider</span></code> 这个类的两个函数： 注册——register、启动——boot。</p>
<p>由于 <code class="docutils literal"><span class="pre">route</span></code> 的注册工作由之前 <code class="docutils literal"><span class="pre">RoutingServiceProvider</span></code> 完成，所以 <code class="docutils literal"><span class="pre">RouteServiceProvider</span></code> 的 <code class="docutils literal"><span class="pre">register</span></code> 是空的，这里它只负责路由的启动与加载工作，我们主要看 <code class="docutils literal"><span class="pre">boot</span></code> ：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="x">namespace Illuminate\Foundation\Support\Providers;</span>

<span class="x">class RouteServiceProvider extends ServiceProvider</span>
<span class="x">{</span>
<span class="x">    public function register()</span>
<span class="x">    {</span>
<span class="x">        //</span>
<span class="x">    }</span>

<span class="x">    public function boot()</span>
<span class="x">    {</span>
<span class="x">        $this-&gt;setRootControllerNamespace();</span>

<span class="x">        if ($this-&gt;app-&gt;routesAreCached()) {</span>
<span class="x">            $this-&gt;loadCachedRoutes();</span>
<span class="x">        } else {</span>
<span class="x">            $this-&gt;loadRoutes();</span>

<span class="x">            $this-&gt;app-&gt;booted(function () {</span>
<span class="x">                $this-&gt;app[&#39;router&#39;]-&gt;getRoutes()-&gt;refreshNameLookups();</span>
<span class="x">                $this-&gt;app[&#39;router&#39;]-&gt;getRoutes()-&gt;refreshActionLookups();</span>
<span class="x">            });</span>
<span class="x">        }</span>
<span class="x">    }</span>

<span class="x">    protected function loadCachedRoutes()</span>
<span class="x">    {</span>
<span class="x">        $this-&gt;app-&gt;booted(function () {</span>
<span class="x">            require $this-&gt;app-&gt;getCachedRoutesPath();</span>
<span class="x">        });</span>
<span class="x">    }</span>

<span class="x">    protected function loadRoutes()</span>
<span class="x">    {</span>
<span class="x">        if (method_exists($this, &#39;map&#39;)) {</span>
<span class="x">            $this-&gt;app-&gt;call([$this, &#39;map&#39;]);</span>
<span class="x">        }</span>
<span class="x">    }</span>
<span class="x">}</span>

<span class="x">class Application extends Container implements ApplicationContract, HttpKernelInterface</span>
<span class="x">{</span>
<span class="x">    public function routesAreCached()</span>
<span class="x">    {</span>
<span class="x">        return $this[&#39;files&#39;]-&gt;exists($this-&gt;getCachedRoutesPath());</span>
<span class="x">    }</span>

<span class="x">    public function getCachedRoutesPath()</span>
<span class="x">    {</span>
<span class="x">        return $this-&gt;bootstrapPath().&#39;/cache/routes.php&#39;;</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>
</div>
<p>从 <code class="docutils literal"><span class="pre">boot</span></code> 中可以看出，laravel 首先去寻找路由的缓存文件，没有缓存文件再去进行加载路由。缓存文件一般在 <code class="docutils literal"><span class="pre">bootstrap/cache/routes.php</span></code> 文件中。它是由 <code class="docutils literal"><span class="pre">route:cache</span></code> 命令生成的。</p>
<p>加载路由主要调用 <code class="docutils literal"><span class="pre">map</span></code> 函数，这个函数一般在 <code class="docutils literal"><span class="pre">App\Providers\RouteServiceProvider</span></code> 这个类中，这个类继承上面的 <code class="docutils literal"><span class="pre">Illuminate\Foundation\Support\Providers\RouteServiceProvider</span></code> :</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">Illuminate\Foundation\Support\Providers\RouteServiceProvider</span> <span class="k">as</span> <span class="nx">ServiceProvider</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">RouteServiceProvider</span> <span class="k">extends</span> <span class="nx">ServiceProvider</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">map</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapApiRoutes</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapWebRoutes</span><span class="p">();</span>

        <span class="c1">//</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">mapWebRoutes</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nx">Route</span><span class="o">::</span><span class="na">middleware</span><span class="p">(</span><span class="s1">&#39;web&#39;</span><span class="p">)</span>
             <span class="o">-&gt;</span><span class="na">namespace</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">namespace</span><span class="p">)</span>
             <span class="o">-&gt;</span><span class="na">group</span><span class="p">(</span><span class="nx">base_path</span><span class="p">(</span><span class="s1">&#39;routes/web.php&#39;</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">mapApiRoutes</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nx">Route</span><span class="o">::</span><span class="na">prefix</span><span class="p">(</span><span class="s1">&#39;api&#39;</span><span class="p">)</span>
             <span class="o">-&gt;</span><span class="na">middleware</span><span class="p">(</span><span class="s1">&#39;api&#39;</span><span class="p">)</span>
             <span class="o">-&gt;</span><span class="na">namespace</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">namespace</span><span class="p">)</span>
             <span class="o">-&gt;</span><span class="na">group</span><span class="p">(</span><span class="nx">base_path</span><span class="p">(</span><span class="s1">&#39;routes/api.php&#39;</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>laravle 将路由分为两个大组： <code class="docutils literal"><span class="pre">api</span></code> 、 <code class="docutils literal"><span class="pre">web</span></code> 。这两个部分的路由分别写在两个文件中： <code class="docutils literal"><span class="pre">routes/web.php</span></code> 、 <code class="docutils literal"><span class="pre">routes/api.php</span></code> 。</p>
</div>
</div>
<div class="section" id="id3">
<h2>路由的加载<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>所谓的路由加载，就是将定义路由时添加的属性，例如 'name'、'domain'、'scheme' 等等保存起来，以待后用。</p>
<p>laravel 定义路由的属性的方法很灵活：</p>
<ul>
<li><p class="first">可以定义在路由群组前，例如：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nx">Route</span><span class="o">::</span><span class="na">domain</span><span class="p">(</span><span class="s1">&#39;route.domain.name&#39;</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">group</span><span class="p">(</span><span class="k">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span><span class="s1">&#39;controller@method&#39;</span><span class="p">);</span>
    <span class="p">})</span>
</pre></div>
</div>
</li>
<li><p class="first">可以定义在路由群组中，例如：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nx">Route</span><span class="o">::</span><span class="na">group</span><span class="p">(</span><span class="s1">&#39;domain&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;group.domain.name&#39;</span><span class="p">,</span><span class="k">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span><span class="s1">&#39;controller@method&#39;</span><span class="p">);</span>
<span class="p">})</span>
</pre></div>
</div>
</li>
<li><p class="first">可以定义在 method 的前面，例如：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nx">Route</span><span class="o">::</span><span class="na">domain</span><span class="p">(</span><span class="s1">&#39;route.domain.name&#39;</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span><span class="s1">&#39;controller@method&#39;</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p class="first">可以定义在 method 中，例如：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,[</span><span class="s1">&#39;domain&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;route.domain.name&#39;</span><span class="p">,</span><span class="s1">&#39;use&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;controller@method&#39;</span><span class="p">]);</span>
</pre></div>
</div>
</li>
<li><p class="first">还可以定义在 method 后，例如：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;{one}&#39;</span><span class="p">,</span> <span class="s1">&#39;use&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;controller@method&#39;</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;(.+)&#39;</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ul>
<p>事实上，路由的加载功能主要有三个类负责： <code class="docutils literal"><span class="pre">Illuminate\Routing\Router</span></code> 、 <code class="docutils literal"><span class="pre">Illuminate\Routing\Route</span></code> 、 <code class="docutils literal"><span class="pre">Illuminate\Routing\RouteRegistrar</span></code> 。</p>
<p><code class="docutils literal"><span class="pre">Router</span></code> 在整个路由功能中都是起着中枢的作用， <code class="docutils literal"><span class="pre">RouteRegistrar</span></code> 主要负责位于 <code class="docutils literal"><span class="pre">group</span></code> 、 <code class="docutils literal"><span class="pre">method</span></code> 这些函数之前的属性注册，例如上面的第一种和第三种， <code class="docutils literal"><span class="pre">route</span></code> 主要负责位于 <code class="docutils literal"><span class="pre">group</span></code> 、 <code class="docutils literal"><span class="pre">method</span></code> 这些函数之后的属性注册，例如第五种。</p>
<div class="section" id="routeregistrar">
<h3>RouteRegistrar 路由加载<a class="headerlink" href="#routeregistrar" title="永久链接至标题">¶</a></h3>
<div class="section" id="groupmethod">
<h4>属性注册(group、method 这些函数之前的属性注册)<a class="headerlink" href="#groupmethod" title="永久链接至标题">¶</a></h4>
<p>当我们想要在 <code class="docutils literal"><span class="pre">Route</span></code> 后面直接利用 <code class="docutils literal"><span class="pre">domain()</span></code> 、 <code class="docutils literal"><span class="pre">name()</span></code> 等函数来为路由注册属性的时候，我们实际调用的是 <code class="docutils literal"><span class="pre">router</span></code> 的魔术方法 <code class="docutils literal"><span class="pre">__call()</span></code> :</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">Router</span> <span class="k">implements</span> <span class="nx">RegistrarContract</span><span class="p">,</span> <span class="nx">BindingRegistrar</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__call</span><span class="p">(</span><span class="nv">$method</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">static</span><span class="o">::</span><span class="na">hasMacro</span><span class="p">(</span><span class="nv">$method</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">macroCall</span><span class="p">(</span><span class="nv">$method</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">(</span><span class="k">new</span> <span class="nx">RouteRegistrar</span><span class="p">(</span><span class="nv">$this</span><span class="p">))</span><span class="o">-&gt;</span><span class="na">attribute</span><span class="p">(</span><span class="nv">$method</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>在类 <code class="docutils literal"><span class="pre">RouteRegistrar</span></code> 中：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">RouteRegistrar</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$allowedAttributes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;as&#39;</span><span class="p">,</span> <span class="s1">&#39;domain&#39;</span><span class="p">,</span> <span class="s1">&#39;middleware&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;namespace&#39;</span><span class="p">,</span> <span class="s1">&#39;prefix&#39;</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">attribute</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">in_array</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">allowedAttributes</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">(</span><span class="s2">&quot;Attribute [</span><span class="si">{</span><span class="nv">$key</span><span class="si">}</span><span class="s2">] does not exist.&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="p">[</span><span class="nx">array_get</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">aliases</span><span class="p">,</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$key</span><span class="p">)]</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h4>添加路由<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h4>
<p>注册属性之后，创建路由的时候，可以仅仅提供 <code class="docutils literal"><span class="pre">uri</span></code> ，可以提供 <code class="docutils literal"><span class="pre">uri</span></code> 与 闭包，可以提供 <code class="docutils literal"><span class="pre">uri</span></code> 与 控制器，可以提供 <code class="docutils literal"><span class="pre">uri</span></code> 与数组：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nx">Route</span><span class="o">::</span><span class="na">as</span><span class="p">(</span><span class="s1">&#39;Foo&#39;</span><span class="p">)</span>
     <span class="o">-&gt;</span><span class="na">namespace</span><span class="p">(</span><span class="s1">&#39;Namespace\\Example\\&#39;</span><span class="p">)</span>
     <span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;foo/bar&#39;</span><span class="p">);</span><span class="c1">//仅仅 uri</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">as</span><span class="p">(</span><span class="s1">&#39;Foo&#39;</span><span class="p">)</span>
     <span class="o">-&gt;</span><span class="na">namespace</span><span class="p">(</span><span class="s1">&#39;Namespace\\Example\\&#39;</span><span class="p">)</span>
     <span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;foo/bar&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
       <span class="p">});</span> <span class="c1">//uri 与闭包</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">as</span><span class="p">(</span><span class="s1">&#39;Foo&#39;</span><span class="p">)</span>
     <span class="o">-&gt;</span><span class="na">namespace</span><span class="p">(</span><span class="s1">&#39;Namespace\\Example\\&#39;</span><span class="p">)</span>
     <span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;foo/bar&#39;</span><span class="p">,</span> <span class="s1">&#39;controller@method&#39;</span><span class="p">);</span><span class="c1">//uri 与控制器</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">as</span><span class="p">(</span><span class="s1">&#39;Foo&#39;</span><span class="p">)</span>
     <span class="o">-&gt;</span><span class="na">namespace</span><span class="p">(</span><span class="s1">&#39;Namespace\\Example\\&#39;</span><span class="p">)</span>
     <span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;foo/bar&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;as&#39;</span><span class="o">=&gt;</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span><span class="s1">&#39;use&#39;</span> <span class="o">=&gt;</span><span class="s1">&#39;controller@method&#39;</span><span class="p">]);</span><span class="c1">//uri 与数组</span>
</pre></div>
</div>
<p>利用 <code class="docutils literal"><span class="pre">get</span></code> 、 <code class="docutils literal"><span class="pre">post</span></code> 等方法创建新的路由时，会调用类 <code class="docutils literal"><span class="pre">RouteRegistrar</span></code> 中的魔术方法 <code class="docutils literal"><span class="pre">__call()</span></code> ：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">RouteRegistrar</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$passthru</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="s1">&#39;patch&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;any&#39;</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__call</span><span class="p">(</span><span class="nv">$method</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$method</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">passthru</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">registerRoute</span><span class="p">(</span><span class="nv">$method</span><span class="p">,</span> <span class="o">...</span><span class="nv">$parameters</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$method</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">allowedAttributes</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">attribute</span><span class="p">(</span><span class="nv">$method</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="nx">BadMethodCallException</span><span class="p">(</span><span class="s2">&quot;Method [</span><span class="si">{</span><span class="nv">$method</span><span class="si">}</span><span class="s2">] does not exist.&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">registerRoute</span><span class="p">(</span><span class="nv">$method</span><span class="p">,</span> <span class="nv">$uri</span><span class="p">,</span> <span class="nv">$action</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$action</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$action</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="p">,</span> <span class="nv">$action</span> <span class="o">?</span> <span class="p">[</span><span class="s1">&#39;uses&#39;</span> <span class="o">=&gt;</span> <span class="nv">$action</span><span class="p">]</span> <span class="o">:</span> <span class="p">[]);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">router</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$method</span><span class="p">}(</span><span class="nv">$uri</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">compileAction</span><span class="p">(</span><span class="nv">$action</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">compileAction</span><span class="p">(</span><span class="nv">$action</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">is_null</span><span class="p">(</span><span class="nv">$action</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$action</span><span class="p">)</span> <span class="o">||</span> <span class="nv">$action</span> <span class="nx">instanceof</span> <span class="nx">Closure</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$action</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;uses&#39;</span> <span class="o">=&gt;</span> <span class="nv">$action</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="p">,</span> <span class="nv">$action</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>也就是说， <code class="docutils literal"><span class="pre">RouteRegistrar</span></code> 在这里会为闭包或控制器等所有非数组的 <code class="docutils literal"><span class="pre">action</span></code> 添加 <code class="docutils literal"><span class="pre">use</span></code> 键，然后才会去 <code class="docutils literal"><span class="pre">router</span></code> 中创建路由。</p>
</div>
<div class="section" id="id5">
<h4>添加路由群组<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h4>
<p>注册属性之后，还可以创建路由群组，但是这时路由群组不允许添加属性 <code class="docutils literal"><span class="pre">action</span></code> ：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">RouteRegistrar</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">group</span><span class="p">(</span><span class="nv">$callback</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">router</span><span class="o">-&gt;</span><span class="na">group</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="p">,</span> <span class="nv">$callback</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="router">
<h3>Router 路由群组加载<a class="headerlink" href="#router" title="永久链接至标题">¶</a></h3>
<p>路由群组的功能可以不断叠加递归，因此每次调用 <code class="docutils literal"><span class="pre">group</span></code> ，都要用新路由群组的属性与旧路由群组属性合并，以待新的路由去继承。 <code class="docutils literal"><span class="pre">group</span></code> 参数可以是闭包函数，也可以是包含定义路由的文件路径。</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">group</span><span class="p">(</span><span class="k">array</span> <span class="nv">$attributes</span><span class="p">,</span> <span class="nv">$routes</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// 合并prefix/namespace/as/where/中间件，形成新的attribute</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">updateGroupStack</span><span class="p">(</span><span class="nv">$attributes</span><span class="p">);</span>

    <span class="sd">/**</span>
<span class="sd">     * 一旦我们更新了组堆栈，我们将加载提供的路由并在创建路由时合并组的属性。 在创建路由之后，我们将弹出堆栈中的属性。</span>
<span class="sd">     */</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">loadRoutes</span><span class="p">(</span><span class="nv">$routes</span><span class="p">);</span> <span class="c1">// 如果存在group方法，则嵌套调用group组</span>

    <span class="nb">array_pop</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">groupStack</span><span class="p">);</span> <span class="c1">// 每处理完嵌套组就弹出一层</span>
<span class="p">}</span>

<span class="k">protected</span> <span class="k">function</span> <span class="nf">updateGroupStack</span><span class="p">(</span><span class="k">array</span> <span class="nv">$attributes</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">groupStack</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// 每次一调用group方法都会获取上一层组的属性，并进行合并处理</span>
        <span class="nv">$attributes</span> <span class="o">=</span> <span class="nx">RouteGroup</span><span class="o">::</span><span class="na">merge</span><span class="p">(</span><span class="nv">$attributes</span><span class="p">,</span> <span class="nb">end</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">groupStack</span><span class="p">));</span> <span class="c1">// 返回数组中最后一个元素的值</span>
    <span class="p">}</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">groupStack</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$attributes</span><span class="p">;</span> <span class="c1">// 数组的最后一个元素就是最终的路由组属性</span>
<span class="p">}</span>

<span class="k">protected</span> <span class="k">function</span> <span class="nf">loadRoutes</span><span class="p">(</span><span class="nv">$routes</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$routes</span> <span class="nx">instanceof</span> <span class="nx">Closure</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$routes</span><span class="p">(</span><span class="nv">$this</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$router</span> <span class="o">=</span> <span class="nv">$this</span><span class="p">;</span> <span class="c1">// 向进入的文件中传入路由器变量</span>

        <span class="k">require</span> <span class="nv">$routes</span><span class="p">;</span> <span class="c1">//不是回调函数就是php文件</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>关于路由群组属性的合并,</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">prefix</span></code> 、 <code class="docutils literal"><span class="pre">as</span></code> 、 <code class="docutils literal"><span class="pre">namespace</span></code> 这几个属性会连接在一起，例如 <code class="docutils literal"><span class="pre">prefix1/prefix2/prefix3</span></code> ；</li>
<li><code class="docutils literal"><span class="pre">where</span></code> 属性数组相同的会被替换，不同的会被合并；</li>
<li><code class="docutils literal"><span class="pre">domain</span></code> 属性会被替换；</li>
<li>其他属性，例如 <code class="docutils literal"><span class="pre">middleware</span></code> 数组会直接被合并，即使存在相同的元素；</li>
</ul>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">RouteGroup</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">merge</span><span class="p">(</span><span class="nv">$new</span><span class="p">,</span> <span class="nv">$old</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$new</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nb">unset</span><span class="p">(</span><span class="nv">$old</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="nv">$new</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="k">static</span><span class="o">::</span><span class="na">formatAs</span><span class="p">(</span><span class="nv">$new</span><span class="p">,</span> <span class="nv">$old</span><span class="p">),</span> <span class="p">[</span>
            <span class="s1">&#39;namespace&#39;</span> <span class="o">=&gt;</span> <span class="k">static</span><span class="o">::</span><span class="na">formatNamespace</span><span class="p">(</span><span class="nv">$new</span><span class="p">,</span> <span class="nv">$old</span><span class="p">),</span>
            <span class="s1">&#39;prefix&#39;</span> <span class="o">=&gt;</span> <span class="k">static</span><span class="o">::</span><span class="na">formatPrefix</span><span class="p">(</span><span class="nv">$new</span><span class="p">,</span> <span class="nv">$old</span><span class="p">),</span>
            <span class="s1">&#39;where&#39;</span> <span class="o">=&gt;</span> <span class="k">static</span><span class="o">::</span><span class="na">formatWhere</span><span class="p">(</span><span class="nv">$new</span><span class="p">,</span> <span class="nv">$old</span><span class="p">),</span>
        <span class="p">]);</span>

        <span class="k">return</span> <span class="nb">array_merge_recursive</span><span class="p">(</span><span class="nx">Arr</span><span class="o">::</span><span class="na">except</span><span class="p">(</span>
            <span class="nv">$old</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;namespace&#39;</span><span class="p">,</span> <span class="s1">&#39;prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;where&#39;</span><span class="p">,</span> <span class="s1">&#39;as&#39;</span><span class="p">]</span>
        <span class="p">),</span> <span class="nv">$new</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h3>Router 路由加载<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h3>
<p>添加路由需要很多步骤，需要将路由本身的属性和路由群组的属性相结合。</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">get</span><span class="p">(</span><span class="nv">$uri</span><span class="p">,</span> <span class="nv">$action</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addRoute</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">],</span> <span class="nv">$uri</span><span class="p">,</span> <span class="nv">$action</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">protected</span> <span class="k">function</span> <span class="nf">addRoute</span><span class="p">(</span><span class="nv">$methods</span><span class="p">,</span> <span class="nv">$uri</span><span class="p">,</span> <span class="nv">$action</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// 把返回的Illuminate\Routing\Route对象存储到本对象中</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">routes</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createRoute</span><span class="p">(</span><span class="nv">$methods</span><span class="p">,</span> <span class="nv">$uri</span><span class="p">,</span> <span class="nv">$action</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">protected</span> <span class="k">function</span> <span class="nf">createRoute</span><span class="p">(</span><span class="nv">$methods</span><span class="p">,</span> <span class="nv">$uri</span><span class="p">,</span> <span class="nv">$action</span><span class="p">)</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 如果路由是路由到一个控制器，我们将在注册它之前将路由动作解析为可接受的数组格式，</span>
<span class="sd">     * 并创建该路由实例本身。 我们需要构建可以调用它的闭包。</span>
<span class="sd">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">actionReferencesController</span><span class="p">(</span><span class="nv">$action</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// 判断是否路由到控制器方法</span>
        <span class="nv">$action</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">convertToControllerAction</span><span class="p">(</span><span class="nv">$action</span><span class="p">);</span> <span class="c1">// 为控制器添加命名空间</span>
    <span class="p">}</span>

    <span class="c1">// 在给定的URI前加上前缀，此时的动作为完整名称，初始化一个路由项</span>
    <span class="nv">$route</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">newRoute</span><span class="p">(</span>
        <span class="nv">$methods</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prefix</span><span class="p">(</span><span class="nv">$uri</span><span class="p">),</span> <span class="nv">$action</span> <span class="c1">// 如果存在组栈，则获取组uri前缀</span>
    <span class="p">);</span>

    <span class="sd">/**</span>
<span class="sd">     * 如果我们有需要合并的组栈，我们将在此路由已创建并准备就绪后立即合并它们。 在我们完成合并后，我们准备将路由返回给调用者。</span>
<span class="sd">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasGroupStack</span><span class="p">())</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mergeGroupAttributesIntoRoute</span><span class="p">(</span><span class="nv">$route</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addWhereClausesToRoute</span><span class="p">(</span><span class="nv">$route</span><span class="p">);</span> <span class="c1">// 初始化路由参数正则表达式，合并了全局定义的模式</span>

    <span class="k">return</span> <span class="nv">$route</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>从上面来看，添加一个新的路由需要：</p>
<ul class="simple">
<li>给组中路由的控制器添加 <code class="docutils literal"><span class="pre">group</span></code> 的 <code class="docutils literal"><span class="pre">namespace</span></code> ；</li>
<li>给路由的 <code class="docutils literal"><span class="pre">uri</span></code> 添加 <code class="docutils literal"><span class="pre">group</span></code> 的 <code class="docutils literal"><span class="pre">prefix</span></code> 前缀；</li>
<li>创建新的路由；</li>
<li>更新路由的属性信息；</li>
<li>为路由添加全局 <code class="docutils literal"><span class="pre">router-pattern</span></code> 正则约束；</li>
<li>把路由添加到 <code class="docutils literal"><span class="pre">RouteCollection</span></code> 中；</li>
</ul>
</div>
<div class="section" id="namespace">
<h3>控制器 namespace<a class="headerlink" href="#namespace" title="永久链接至标题">¶</a></h3>
<p>路由控制器的命名空间一般不用特别指定，默认值是 <code class="docutils literal"><span class="pre">\App\Http\Controllers</span></code> ，每次创建新的路由，都要将默认的命名空间添加到控制器中去：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">protected</span> <span class="k">function</span> <span class="nf">actionReferencesController</span><span class="p">(</span><span class="nv">$action</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$action</span> <span class="nx">instanceof</span> <span class="nx">Closure</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$action</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$action</span><span class="p">[</span><span class="s1">&#39;uses&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$action</span><span class="p">[</span><span class="s1">&#39;uses&#39;</span><span class="p">]));</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">protected</span> <span class="k">function</span> <span class="nf">convertToControllerAction</span><span class="p">(</span><span class="nv">$action</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$action</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$action</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;uses&#39;</span> <span class="o">=&gt;</span> <span class="nv">$action</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">groupStack</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$action</span><span class="p">[</span><span class="s1">&#39;uses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prependGroupNamespace</span><span class="p">(</span><span class="nv">$action</span><span class="p">[</span><span class="s1">&#39;uses&#39;</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="nv">$action</span><span class="p">[</span><span class="s1">&#39;controller&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$action</span><span class="p">[</span><span class="s1">&#39;uses&#39;</span><span class="p">];</span>

    <span class="k">return</span> <span class="nv">$action</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">protected</span> <span class="k">function</span> <span class="nf">prependGroupNamespace</span><span class="p">(</span><span class="nv">$class</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$group</span> <span class="o">=</span> <span class="nb">end</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">groupStack</span><span class="p">);</span>

    <span class="k">return</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$group</span><span class="p">[</span><span class="s1">&#39;namespace&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">strpos</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="s1">&#39;\\&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">0</span>
            <span class="o">?</span> <span class="nv">$group</span><span class="p">[</span><span class="s1">&#39;namespace&#39;</span><span class="p">]</span><span class="o">.</span><span class="s1">&#39;\\&#39;</span><span class="o">.</span><span class="nv">$class</span> <span class="o">:</span> <span class="nv">$class</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="uri">
<h3>uri 前缀<a class="headerlink" href="#uri" title="永久链接至标题">¶</a></h3>
<p>在创建新的路由前，需要将路由群组的 <code class="docutils literal"><span class="pre">prefix</span></code> 添加到路由的 <code class="docutils literal"><span class="pre">uri</span></code> 中：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">protected</span> <span class="k">function</span> <span class="nf">prefix</span><span class="p">(</span><span class="nv">$uri</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nb">trim</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getLastGroupPrefix</span><span class="p">(),</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$uri</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">),</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">?:</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">getLastGroupPrefix</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">groupStack</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$last</span> <span class="o">=</span> <span class="nb">end</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">groupStack</span><span class="p">);</span>

        <span class="k">return</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$last</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$last</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h3>创建新的路由<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h3>
<p>路由的创建需要 <code class="docutils literal"><span class="pre">Route</span></code> 类：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">protected</span> <span class="k">function</span> <span class="nf">newRoute</span><span class="p">(</span><span class="nv">$methods</span><span class="p">,</span> <span class="nv">$uri</span><span class="p">,</span> <span class="nv">$action</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">new</span> <span class="nx">Route</span><span class="p">(</span><span class="nv">$methods</span><span class="p">,</span> <span class="nv">$uri</span><span class="p">,</span> <span class="nv">$action</span><span class="p">))</span>
                <span class="o">-&gt;</span><span class="na">setRouter</span><span class="p">(</span><span class="nv">$this</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">setContainer</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>关于 <code class="docutils literal"><span class="pre">Router</span></code> 类添加新的路由我们在下一部分详细说。</p>
</div>
<div class="section" id="id8">
<h3>更新路由属性信息<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h3>
<p>路由属性一般存放在 <code class="docutils literal"><span class="pre">Route</span></code> 的 <code class="docutils literal"><span class="pre">$action</span></code> 属性中。创建新的路由之后，需要将路由本身的属性 <code class="docutils literal"><span class="pre">action</span></code> 与路由群组的属性结合在一起：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">hasGroupStack</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">groupStack</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">protected</span> <span class="k">function</span> <span class="nf">mergeGroupAttributesIntoRoute</span><span class="p">(</span><span class="nv">$route</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$route</span><span class="o">-&gt;</span><span class="na">setAction</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mergeWithLastGroup</span><span class="p">(</span><span class="nv">$route</span><span class="o">-&gt;</span><span class="na">getAction</span><span class="p">()));</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h3>添加全局正则约束到路由<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h3>
<p>上一篇文章我们说过，我们可以为路由通过 <code class="docutils literal"><span class="pre">pattern</span></code> 方法添加全局的参数正则约束，所有每次添加新的路由都要将这个全局正则约束添加到路由中：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">pattern</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$pattern</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">patterns</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$pattern</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">protected</span> <span class="k">function</span> <span class="nf">addWhereClausesToRoute</span><span class="p">(</span><span class="nv">$route</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$route</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="nb">array_merge</span><span class="p">(</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">patterns</span><span class="p">,</span> <span class="nv">$route</span><span class="o">-&gt;</span><span class="na">getAction</span><span class="p">()[</span><span class="s1">&#39;where&#39;</span><span class="p">]</span> <span class="o">??</span> <span class="p">[]</span> <span class="c1">// 和全局可用参数模式合并</span>
    <span class="p">));</span>

    <span class="k">return</span> <span class="nv">$route</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id10">
<h3>Route对象(路由项)构造<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h3>
<p>前面说过，路由项是由 Route 这个类表示的：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$methods</span><span class="p">,</span> <span class="nv">$uri</span><span class="p">,</span> <span class="nv">$action</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uri</span> <span class="o">=</span> <span class="nv">$uri</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">methods</span> <span class="o">=</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nv">$methods</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">action</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseAction</span><span class="p">(</span><span class="nv">$action</span><span class="p">);</span> <span class="c1">// 规范动作</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">methods</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="nb">in_array</span><span class="p">(</span><span class="s1">&#39;HEAD&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">methods</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">methods</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">;</span> <span class="c1">// 有GET方法，则必然支持HEAD方法</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">action</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]))</span> <span class="p">{</span> <span class="c1">// 如果动作设置前缀，则添加</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prefix</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">action</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>由此可以看出，路由的创建主要是路由的各个属性的初始化，其中值得注意的有两个： <code class="docutils literal"><span class="pre">action</span></code> 与 <code class="docutils literal"><span class="pre">prefix</span></code> 。</p>
<div class="section" id="action">
<h4>action 解析<a class="headerlink" href="#action" title="永久链接至标题">¶</a></h4>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">protected</span> <span class="k">function</span> <span class="nf">parseAction</span><span class="p">(</span><span class="nv">$action</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">RouteAction</span><span class="o">::</span><span class="na">parse</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uri</span><span class="p">,</span> <span class="nv">$action</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>我们可以看出，添加新的路由时， <code class="docutils literal"><span class="pre">action</span></code> 属性需要利用 <code class="docutils literal"><span class="pre">RouteAction</span></code> 类：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">RouteAction</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">parse</span><span class="p">(</span><span class="nv">$uri</span><span class="p">,</span> <span class="nv">$action</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">is_null</span><span class="p">(</span><span class="nv">$action</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">static</span><span class="o">::</span><span class="na">missingAction</span><span class="p">(</span><span class="nv">$uri</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">is_callable</span><span class="p">(</span><span class="nv">$action</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;uses&#39;</span> <span class="o">=&gt;</span> <span class="nv">$action</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$action</span><span class="p">[</span><span class="s1">&#39;uses&#39;</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$action</span><span class="p">[</span><span class="s1">&#39;uses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">static</span><span class="o">::</span><span class="na">findCallable</span><span class="p">(</span><span class="nv">$action</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$action</span><span class="p">[</span><span class="s1">&#39;uses&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="nx">Str</span><span class="o">::</span><span class="na">contains</span><span class="p">(</span><span class="nv">$action</span><span class="p">[</span><span class="s1">&#39;uses&#39;</span><span class="p">],</span> <span class="s1">&#39;@&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$action</span><span class="p">[</span><span class="s1">&#39;uses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">static</span><span class="o">::</span><span class="na">makeInvokable</span><span class="p">(</span><span class="nv">$action</span><span class="p">[</span><span class="s1">&#39;uses&#39;</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$action</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">findCallable</span><span class="p">(</span><span class="k">array</span> <span class="nv">$action</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Arr</span><span class="o">::</span><span class="na">first</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="nv">$key</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">is_callable</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">is_numeric</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">makeInvokable</span><span class="p">(</span><span class="nv">$action</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">method_exists</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="s1">&#39;__invoke&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">UnexpectedValueException</span><span class="p">(</span><span class="s2">&quot;Invalid route action: [</span><span class="si">{</span><span class="nv">$action</span><span class="si">}</span><span class="s2">].&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$action</span><span class="o">.</span><span class="s1">&#39;@__invoke&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>前面的博客我们说过，创建路由的时候，除了为路由分配控制器之外，还可以为路由分配闭包函数，还有类函数，例如之前说的单动作控制器：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$router</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;foo/bar2&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">‘domain’</span> <span class="o">=&gt;</span> <span class="s1">&#39;www.example.com&#39;</span><span class="p">,</span> <span class="s1">&#39;Illuminate\Tests\Routing\ActionStub&#39;</span><span class="p">]);</span>

<span class="k">class</span> <span class="nc">ActionStub</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__invoke</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;hello&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>因此，解析 action 主要做两件事：</p>
<ul class="simple">
<li>为闭包函数添加 <code class="docutils literal"><span class="pre">use</span></code> 键。对于此时没有 <code class="docutils literal"><span class="pre">use</span></code> 键的路由，由于之前在 <code class="docutils literal"><span class="pre">Router</span></code> 中已经为控制器添加 <code class="docutils literal"><span class="pre">use</span></code> 键，因此这时没有 <code class="docutils literal"><span class="pre">use</span></code> 键的，必然是闭包函数，在这里直接或者在 <code class="docutils literal"><span class="pre">action</span></code> 中寻找闭包函数后，为闭包函数添加 <code class="docutils literal"><span class="pre">use</span></code> 键。</li>
<li>单动作控制器添加 <code class="docutils literal"><span class="pre">__invoke</span></code> 。对于单动作控制器来说，此时已经和控制器一样拥有 'use' 键，但是并没有 <code class="docutils literal"><span class="pre">&#64;</span></code> 符号，此时就会调用 <code class="docutils literal"><span class="pre">makeInvokable</span></code> 函数来将 <code class="docutils literal"><span class="pre">__invoke</span></code> 添加到后面。</li>
</ul>
</div>
<div class="section" id="prefix">
<h4>prefix 前缀<a class="headerlink" href="#prefix" title="永久链接至标题">¶</a></h4>
<p>路由自身也有 <code class="docutils literal"><span class="pre">prefix</span></code> 属性，而且这个属性要加在其他 <code class="docutils literal"><span class="pre">prefix</span></code> 的最前面，作为路由的 <code class="docutils literal"><span class="pre">uri</span></code> ：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">prefix</span><span class="p">(</span><span class="nv">$prefix</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$uri</span> <span class="o">=</span> <span class="nb">rtrim</span><span class="p">(</span><span class="nv">$prefix</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nb">ltrim</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uri</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uri</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$uri</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="route-method">
<h2>Route 路由属性加载(method 函数之后的属性注册)<a class="headerlink" href="#route-method" title="永久链接至标题">¶</a></h2>
<p>除了 <code class="docutils literal"><span class="pre">RouteRegistrar</span></code> 之外， <code class="docutils literal"><span class="pre">Route</span></code> 也可以为路由添加属性：</p>
<div class="section" id="id11">
<h3>prefix 前缀<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h3>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">prefix</span><span class="p">(</span><span class="nv">$prefix</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$uri</span> <span class="o">=</span> <span class="nb">rtrim</span><span class="p">(</span><span class="nv">$prefix</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nb">ltrim</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uri</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">uri</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$uri</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="where">
<h3>where 正则约束<a class="headerlink" href="#where" title="永久链接至标题">¶</a></h3>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">where</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$expression</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseWhere</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$expression</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$name</span> <span class="o">=&gt;</span> <span class="nv">$expression</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wheres</span><span class="p">[</span><span class="nv">$name</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$expression</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">protected</span> <span class="k">function</span> <span class="nf">parseWhere</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$expression</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$name</span> <span class="o">:</span> <span class="p">[</span><span class="nv">$name</span> <span class="o">=&gt;</span> <span class="nv">$expression</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="middleware">
<h3>middleware 中间件<a class="headerlink" href="#middleware" title="永久链接至标题">¶</a></h3>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">middleware</span><span class="p">(</span><span class="nv">$middleware</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">is_null</span><span class="p">(</span><span class="nv">$middleware</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nx">Arr</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">action</span><span class="p">,</span> <span class="s1">&#39;middleware&#39;</span><span class="p">,</span> <span class="p">[]);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$middleware</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$middleware</span> <span class="o">=</span> <span class="nb">func_get_args</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">action</span><span class="p">[</span><span class="s1">&#39;middleware&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span>
        <span class="p">(</span><span class="k">array</span><span class="p">)</span> <span class="nx">Arr</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">action</span><span class="p">,</span> <span class="s1">&#39;middleware&#39;</span><span class="p">,</span> <span class="p">[]),</span> <span class="nv">$middleware</span>
    <span class="p">);</span>

    <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="uses">
<h3>uses 控制器<a class="headerlink" href="#uses" title="永久链接至标题">¶</a></h3>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">uses</span><span class="p">(</span><span class="nv">$action</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$action</span> <span class="o">=</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$action</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addGroupNamespaceToStringUses</span><span class="p">(</span><span class="nv">$action</span><span class="p">)</span> <span class="o">:</span> <span class="nv">$action</span><span class="p">;</span>

    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setAction</span><span class="p">(</span><span class="nb">array_merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">action</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parseAction</span><span class="p">([</span>
        <span class="s1">&#39;uses&#39;</span> <span class="o">=&gt;</span> <span class="nv">$action</span><span class="p">,</span>
        <span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="nv">$action</span><span class="p">,</span>
    <span class="p">])));</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="name">
<h3>name 命名<a class="headerlink" href="#name" title="永久链接至标题">¶</a></h3>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">name</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">action</span><span class="p">[</span><span class="s1">&#39;as&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">action</span><span class="p">[</span><span class="s1">&#39;as&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">action</span><span class="p">[</span><span class="s1">&#39;as&#39;</span><span class="p">]</span><span class="o">.</span><span class="nv">$name</span> <span class="o">:</span> <span class="nv">$name</span><span class="p">;</span>

    <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="routecollection">
<h2>RouteCollection 添加路由<a class="headerlink" href="#routecollection" title="永久链接至标题">¶</a></h2>
<p>在上面的部分，我们看到添加路由的代码：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">protected</span> <span class="k">function</span> <span class="nf">addRoute</span><span class="p">(</span><span class="nv">$methods</span><span class="p">,</span> <span class="nv">$uri</span><span class="p">,</span> <span class="nv">$action</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">routes</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createRoute</span><span class="p">(</span><span class="nv">$methods</span><span class="p">,</span> <span class="nv">$uri</span><span class="p">,</span> <span class="nv">$action</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>新创建的路由会加入到 <code class="docutils literal"><span class="pre">RouteCollection</span></code> 中，会更新类中的 <code class="docutils literal"><span class="pre">routes</span></code> 、 <code class="docutils literal"><span class="pre">allRoutes</span></code> 、 <code class="docutils literal"><span class="pre">nameList</span></code> 、 <code class="docutils literal"><span class="pre">actionList</span></code> 。</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">add</span><span class="p">(</span><span class="nx">Route</span> <span class="nv">$route</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addToCollections</span><span class="p">(</span><span class="nv">$route</span><span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addLookups</span><span class="p">(</span><span class="nv">$route</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$route</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">protected</span> <span class="k">function</span> <span class="nf">addToCollections</span><span class="p">(</span><span class="nv">$route</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$domainAndUri</span> <span class="o">=</span> <span class="nv">$route</span><span class="o">-&gt;</span><span class="na">domain</span><span class="p">()</span><span class="o">.</span><span class="nv">$route</span><span class="o">-&gt;</span><span class="na">uri</span><span class="p">();</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$route</span><span class="o">-&gt;</span><span class="na">methods</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$method</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">routes</span><span class="p">[</span><span class="nv">$method</span><span class="p">][</span><span class="nv">$domainAndUri</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$route</span><span class="p">;</span> <span class="c1">// 请求方法和请求路径与路由项映射关系</span>
    <span class="p">}</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">allRoutes</span><span class="p">[</span><span class="nv">$method</span><span class="o">.</span><span class="nv">$domainAndUri</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$route</span><span class="p">;</span><span class="c1">// 请求方法连接请求路径与路由项映射关系</span>
<span class="p">}</span>

<span class="k">protected</span> <span class="k">function</span> <span class="nf">addLookups</span><span class="p">(</span><span class="nv">$route</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$action</span> <span class="o">=</span> <span class="nv">$route</span><span class="o">-&gt;</span><span class="na">getAction</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$action</span><span class="p">[</span><span class="s1">&#39;as&#39;</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">nameList</span><span class="p">[</span><span class="nv">$action</span><span class="p">[</span><span class="s1">&#39;as&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nv">$route</span><span class="p">;</span> <span class="c1">// 路由名称和路由项映射关系</span>
    <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$action</span><span class="p">[</span><span class="s1">&#39;controller&#39;</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addToActionList</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$route</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">protected</span> <span class="k">function</span> <span class="nf">addToActionList</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$route</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">actionList</span><span class="p">[</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$action</span><span class="p">[</span><span class="s1">&#39;controller&#39;</span><span class="p">],</span> <span class="s1">&#39;\\&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="nv">$route</span><span class="p">;</span> <span class="c1">// 控制器加动作完全名称和路由项映射关系</span>
<span class="p">}</span>
</pre></div>
</div>
<p>我们在上面路由的注册启动章节说道，路由的启动是 namespace <code class="docutils literal"><span class="pre">Illuminate\Foundation\Support\Providers\RouteServiceProvider</span></code> 完成的，调用的是 <code class="docutils literal"><span class="pre">boot</span></code> 函数：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">boot</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// 设置路由UrlGenerator对象的控制器根命名空间</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setRootControllerNamespace</span><span class="p">();</span>
    <span class="c1">// 是否存在 bootstrap/cache/routes.php文件</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="o">-&gt;</span><span class="na">routesAreCached</span><span class="p">())</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">loadCachedRoutes</span><span class="p">();</span> <span class="c1">// 当应用启动完成加载路由缓存文件</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">loadRoutes</span><span class="p">();</span> <span class="c1">// 调用路由提供器的map()方法</span>
        <span class="c1">// 应用启动后调用的函数</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="o">-&gt;</span><span class="na">booted</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="c1">// Illuminate\Routing\Router.php</span>
            <span class="c1">// Illuminate\Routing\RouteCollection</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="p">[</span><span class="s1">&#39;router&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">getRoutes</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">refreshNameLookups</span><span class="p">();</span> <span class="c1">// 刷新路由名称和路由对象映射表</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="p">[</span><span class="s1">&#39;router&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">getRoutes</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">refreshActionLookups</span><span class="p">();</span> <span class="c1">// 刷新控制器加动作完全名称和路由对象的映射表</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>在最后两句，程序将会在所有服务都启动后运行 <code class="docutils literal"><span class="pre">refreshNameLookups</span></code> ，把所有的路由项加载到 <code class="docutils literal"><span class="pre">RouteCollection</span></code> 中 <code class="docutils literal"><span class="pre">$nameList</span></code> 属性中和 <code class="docutils literal"><span class="pre">refreshActionLookups</span></code> 函数，把所有路由项加载到 <code class="docutils literal"><span class="pre">RouteCollection</span></code> 中 <code class="docutils literal"><span class="pre">$actionList</span></code> 属性中。</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, lzh.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.0',
            LANGUAGE:'zh',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  

<script type="text/javascript">
  
      $(document).ready(function(){
        var offset = sessionStorage.getItem("offsetTop");
        $('.wy-side-scroll').scrollTop(offset);
        sessionStorage.setItem("offsetTop", 0);


        $('.wy-menu > ul').click(function(){
            sessionStorage.setItem("offsetTop", $('.wy-side-scroll').scrollTop());
        });
      })

  </script> 

</body>
</html>