

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>34. Laravel用户授权系统 &mdash; laravel 1.0 文档</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="索引"
              href="genindex.html"/>
        <link rel="search" title="搜索" href="search.html"/>
    <link rel="top" title="laravel 1.0 文档" href="index.html"/>
        <link rel="next" title="35. 命令行" href="Laravel的命令行.html"/>
        <link rel="prev" title="33. Laravel 的 API 认证系统 Passport" href="Laravel的API认证系统Passport.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> laravel
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">目录:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="请求到响应的生命周期-web.html">1. 请求到web响应的生命周期</a></li>
<li class="toctree-l1"><a class="reference internal" href="请求到响应的生命周期-console.html">2. 请求到console响应的生命周期</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的容器.html">3. 容器</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Facades.html">4. Facades</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Facades原理分析.html">5. Facade的原理</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的服务提供器.html">6. 服务提供器</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的路由.html">7. 路由</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的路由—路由的正则编译.html">8. 路由的正则编译</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的路由—路由的匹配与参数绑定.html">9. 路由的匹配与参数绑定</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的路由—路由中间件.html">10. 路由的中间件</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的中间件.html">11. 中间件</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的中间件-SubstituteBindings.html">12. 中间件SubstituteBindings</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的中间件-CSRF.html">13. 中间件CSRF</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的请求.html">14. 请求</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的控制器.html">15. 控制器</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的控制器—控制器方法的参数构建与运行.html">16. 控制器方法的参数构建与运行</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的响应.html">17. 响应</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的视图.html">18. 视图</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的生成URL.html">19. URL</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Session.html">20. Session</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Session原理分析.html">21. Session原理分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的表单验证机制详解.html">22. 表单验证机制详解</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的日志.html">23. 日志</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的异常和错误处理.html">24. 异常和错误处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的异常和错误处理原理分析.html">25. 异常和错误处理原理分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Blade.html">26. Blade</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的blade原理分析.html">27. Blade原理分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的前端.html">28. 前端</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Mix.html">29. Mix</a></li>
<li class="toctree-l1"><a class="reference internal" href="laravel-mix.html">30. mix使用手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的用户认证系统.html">31. Laravel 的用户认证系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="用户认证JWT.html">32. 用户认证JWT</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的API认证系统Passport.html">33. Laravel 的 API 认证系统 Passport</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">34. Laravel用户授权系统</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id2">34.1. 简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gates">34.2. Gates</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id3">34.2.1. 编写 Gates</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">34.2.2. 资源 Gates</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">34.2.3. 授权动作</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id6">34.3. 策略</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id7">34.3.1. 生成策略</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">34.3.2. 注册策略</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id9">34.3.3. 编写策略方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id12">34.3.4. 使用策略授权动作</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id24">34.4. Laravel常用的授权包</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的命令行.html">35. 命令行</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的广播系统.html">36. 广播</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的广播系统原理分析.html">37. 广播系统原理分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的缓存系统.html">38. 缓存</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的集合Collection.html">39. 集合</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的事件系统.html">40. 事件</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的事件系统原理分析.html">41. 事件系统原理分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的文件存储.html">42. 文件存储</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的辅助函数-字符串操作.html">43. 辅助函数-字符串函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的辅助函数-数组和对象操作.html">44. 辅助函数-数组和对象函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的辅助函数-路径操作.html">45. 辅助函数-路径函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的辅助函数-tap分析.html">46. 辅助函数-Tap函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的辅助函数-其它.html">47. 辅助函数-其它杂项</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的邮件发送功能.html">48. 邮件</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的消息通知.html">49. 通知</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel Queue——消息队列任务与分发源码剖析.html">50. 消息队列任务与分发源码剖析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的任务调度.html">51. 任务调度</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据库—原始方式.html">52. 数据库-原始操作</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据库—查询构造器.html">53. 数据库-查询构建器</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据分页.html">54. 数据分页</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据分页原理分析.html">55. 数据分页原理分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据库迁移.html">56. 数据库迁移</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据库填充.html">57. 数据库填充</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Redis.html">58. Redis</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的Redis原理分析.html">59. Redis原理分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据库—Eloquent.html">60. Eloquent</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据库—Eloquent关联.html">61. Eloquent关联</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的数据库—Eloquent修改器.html">62. Eloquent修改器</a></li>
<li class="toctree-l1"><a class="reference internal" href="Laravel的验证规则.html">63. 验证规则</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">laravel</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>34. Laravel用户授权系统</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
        
        <a href="http://blog.liaozhonghao.cn" rel="nofollow"> 返回主页</a>
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="laravel">
<h1><a class="toc-backref" href="#id26">34. Laravel用户授权系统</a><a class="headerlink" href="#laravel" title="永久链接至标题">¶</a></h1>
<div class="contents topic" id="id1">
<p class="topic-title first">目录</p>
<ul class="simple">
<li><a class="reference internal" href="#laravel" id="id26">Laravel用户授权系统</a><ul>
<li><a class="reference internal" href="#id2" id="id27">简介</a></li>
<li><a class="reference internal" href="#gates" id="id28">Gates</a><ul>
<li><a class="reference internal" href="#id3" id="id29">编写 Gates</a></li>
<li><a class="reference internal" href="#id4" id="id30">资源 Gates</a></li>
<li><a class="reference internal" href="#id5" id="id31">授权动作</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6" id="id32">策略</a><ul>
<li><a class="reference internal" href="#id7" id="id33">生成策略</a></li>
<li><a class="reference internal" href="#id8" id="id34">注册策略</a></li>
<li><a class="reference internal" href="#id9" id="id35">编写策略方法</a><ul>
<li><a class="reference internal" href="#id10" id="id36">不包含模型方法</a></li>
<li><a class="reference internal" href="#id11" id="id37">策略过滤器</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id12" id="id38">使用策略授权动作</a><ul>
<li><a class="reference internal" href="#id13" id="id39">通过中间件</a></li>
<li><a class="reference internal" href="#gate" id="id40">通过Gate门面</a></li>
<li><a class="reference internal" href="#id15" id="id41">通过控制器辅助函数</a></li>
<li><a class="reference internal" href="#id21" id="id42">通过用户模型</a></li>
<li><a class="reference internal" href="#blade" id="id43">通过Blade模板</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id24" id="id44">Laravel常用的授权包</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id27">34.1. 简介</a><a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>除了内置开箱即用的 用户认证 服务外， <code class="docutils literal"><span class="pre">Laravel</span></code> 还提供一种更简单的方式来处理用户授权动作。类似用户认证， <code class="docutils literal"><span class="pre">Laravel</span></code> 有 2 种主要方式来实现用户授权： <code class="docutils literal"><span class="pre">gates</span></code> 和策略。</p>
<p>可以把 <code class="docutils literal"><span class="pre">gates</span></code> 和策略类比于路由和控制器。 <code class="docutils literal"><span class="pre">Gates</span></code> 提供了一个简单的、基于闭包的方式来授权认证。策略则和控制器类似，在特定的模型或者资源中通过分组来实现授权认证的逻辑。我们先来看看 <code class="docutils literal"><span class="pre">gates</span></code> ，然后再看策略。</p>
<p>在你的应用中，不要将 <code class="docutils literal"><span class="pre">gates</span></code> 和策略当作相互排斥的方式。大部分应用很可能同时包含 <code class="docutils literal"><span class="pre">gates</span></code> 和策略，并且能很好的工作。 <code class="docutils literal"><span class="pre">Gates</span></code> <strong>大部分应用在模型和资源无关的地方，比如查看管理员的面板。与之相反，策略应该用在特定的模型或者资源中。</strong></p>
</div>
<div class="section" id="gates">
<h2><a class="toc-backref" href="#id28">34.2. Gates</a><a class="headerlink" href="#gates" title="永久链接至标题">¶</a></h2>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id29">34.2.1. 编写 Gates</a><a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal"><span class="pre">Gates</span></code> 是用来决定用户是否授权执行给定的动作的闭包函数，并且典型的做法是在 <code class="docutils literal"><span class="pre">App\Providers\AuthServiceProvider</span></code> 类中使用 <code class="docutils literal"><span class="pre">Gate</span></code> 门面定义。 <code class="docutils literal"><span class="pre">Gates</span></code> 接受一个用户实例作为第一个参数，并且可以接受可选参数，比如相关的 <code class="docutils literal"><span class="pre">Eloquent</span></code> 模型：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * 注册任意用户认证、用户授权服务。</span>
<span class="sd"> *</span>
<span class="sd"> * @return void</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">boot</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">registerPolicies</span><span class="p">();</span>

    <span class="nx">Gate</span><span class="o">::</span><span class="na">define</span><span class="p">(</span><span class="s1">&#39;update-post&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="nv">$post</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">==</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">user_id</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">Gates</span></code> 也可以使用 <code class="docutils literal"><span class="pre">Class&#64;method</span></code> 风格的回调字符串来定义，比如控制器:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * Register any authentication / authorization services.</span>
<span class="sd"> *</span>
<span class="sd"> * @return void</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">boot</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">registerPolicies</span><span class="p">();</span>

    <span class="nx">Gate</span><span class="o">::</span><span class="na">define</span><span class="p">(</span><span class="s1">&#39;update-post&#39;</span><span class="p">,</span> <span class="s1">&#39;PostPolicy@update&#39;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id30">34.2.2. 资源 Gates</a><a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h3>
<p>你还可以使用 <code class="docutils literal"><span class="pre">resource</span></code> 方法一次性定义多个 Gate 功能:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nx">Gate</span><span class="o">::</span><span class="na">resource</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="s1">&#39;PostPolicy&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>这与手动编写以下 Gate 定义相同：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nx">Gate</span><span class="o">::</span><span class="na">define</span><span class="p">(</span><span class="s1">&#39;posts.view&#39;</span><span class="p">,</span> <span class="s1">&#39;PostPolicy@view&#39;</span><span class="p">);</span>
<span class="nx">Gate</span><span class="o">::</span><span class="na">define</span><span class="p">(</span><span class="s1">&#39;posts.create&#39;</span><span class="p">,</span> <span class="s1">&#39;PostPolicy@create&#39;</span><span class="p">);</span>
<span class="nx">Gate</span><span class="o">::</span><span class="na">define</span><span class="p">(</span><span class="s1">&#39;posts.update&#39;</span><span class="p">,</span> <span class="s1">&#39;PostPolicy@update&#39;</span><span class="p">);</span>
<span class="nx">Gate</span><span class="o">::</span><span class="na">define</span><span class="p">(</span><span class="s1">&#39;posts.delete&#39;</span><span class="p">,</span> <span class="s1">&#39;PostPolicy@delete&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>默认情况下将会定义 <code class="docutils literal"><span class="pre">view</span></code> ， <code class="docutils literal"><span class="pre">create</span></code> ， <code class="docutils literal"><span class="pre">update</span></code> ，和 <code class="docutils literal"><span class="pre">delete</span></code> 功能。 通过将数组作为第三个参数传递给 <code class="docutils literal"><span class="pre">resource</span></code> 方法，您可以覆盖或添加新功能到默认的功能。 数组的键定义能力的名称，而值定义方法名称。 例如，以下代码将创建两个新的 <code class="docutils literal"><span class="pre">Gate</span></code> 定义： <code class="docutils literal"><span class="pre">posts.image</span></code> 和 <code class="docutils literal"><span class="pre">posts.photo</span></code> ：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nx">Gate</span><span class="o">::</span><span class="na">resource</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="s1">&#39;PostPolicy&#39;</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">&#39;image&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;updateImage&#39;</span><span class="p">,</span>
    <span class="s1">&#39;photo&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;updatePhoto&#39;</span><span class="p">,</span>
<span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id31">34.2.3. 授权动作</a><a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h3>
<p>使用 <code class="docutils literal"><span class="pre">gates</span></code> 来授权动作时，应使用 <code class="docutils literal"><span class="pre">allows</span></code> 或 <code class="docutils literal"><span class="pre">denies</span></code> 方法。注意你并不需要传递当前认证通过的用户给这些方法。 <code class="docutils literal"><span class="pre">Laravel</span></code>  会自动处理好传入的用户，然后传递给 <code class="docutils literal"><span class="pre">gate</span></code> 闭包函数：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">Gate</span><span class="o">::</span><span class="na">allows</span><span class="p">(</span><span class="s1">&#39;update-post&#39;</span><span class="p">,</span> <span class="nv">$post</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// 指定用户可以更新博客...</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">Gate</span><span class="o">::</span><span class="na">denies</span><span class="p">(</span><span class="s1">&#39;update-post&#39;</span><span class="p">,</span> <span class="nv">$post</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// 指定用户不能更新博客...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>如果需要指定一个特定用户是否可以访问某个动作，可以使用 <code class="docutils literal"><span class="pre">Gate</span></code> 门面中的 <code class="docutils literal"><span class="pre">forUser</span></code> 方法：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">Gate</span><span class="o">::</span><span class="na">forUser</span><span class="p">(</span><span class="nv">$user</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">allows</span><span class="p">(</span><span class="s1">&#39;update-post&#39;</span><span class="p">,</span> <span class="nv">$post</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// 指定用户可以更新博客...</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">Gate</span><span class="o">::</span><span class="na">forUser</span><span class="p">(</span><span class="nv">$user</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">denies</span><span class="p">(</span><span class="s1">&#39;update-post&#39;</span><span class="p">,</span> <span class="nv">$post</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// 指定用户不能更新博客...</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id6">
<h2><a class="toc-backref" href="#id32">34.3. 策略</a><a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h2>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id33">34.3.1. 生成策略</a><a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h3>
<p><strong>策略是在特定模型或者资源中组织授权逻辑的类。</strong> 例如，如果你的应用是一个博客，会有一个 <code class="docutils literal"><span class="pre">Post</span></code> 模型和一个相应的 <code class="docutils literal"><span class="pre">PostPolicy</span></code> 来授权用户动作，比如创建或者更新博客。</p>
<p>可以使用 <code class="docutils literal"><span class="pre">make:policy</span> <span class="pre">artisan</span></code> 命令来生成策略。生成的策略将放置在 <code class="docutils literal"><span class="pre">app/Policies</span></code> 目录。如果在你的应用中不存在这个目录，那么 <code class="docutils literal"><span class="pre">Laravel</span></code> 会自动创建：</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>php artisan make:policy PostPolicy
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">make:policy</span></code> 会生成空的策略类。如果希望生成的类包含基本的「CRUD」策略方法， 可以在使用命令时指定 <code class="docutils literal"><span class="pre">--model</span></code> 选项，会自动包含 <code class="docutils literal"><span class="pre">view</span></code> 、 <code class="docutils literal"><span class="pre">create</span></code> 、 <code class="docutils literal"><span class="pre">update</span></code> 和 <code class="docutils literal"><span class="pre">delete</span></code> 动作：</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>php artisan make:policy PostPolicy --model<span class="o">=</span>Post
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p class="last">所有授权策略会通过 <code class="docutils literal"><span class="pre">Laravel</span></code> 服务容器 解析，意指你可以在授权策略的构造器对任何需要的依赖使用类型提示，它们将会被自动注入。</p>
</div>
</div>
<div class="section" id="id8">
<h3><a class="toc-backref" href="#id34">34.3.2. 注册策略</a><a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h3>
<p>一旦该授权策略存在，需要将它进行注册。新的 <code class="docutils literal"><span class="pre">Laravel</span></code> 应用中包含的 <code class="docutils literal"><span class="pre">AuthServiceProvider</span></code> 包含了一个 <code class="docutils literal"><span class="pre">policies</span></code> 属性，可将各种模型对应至管理它们的授权策略。注册一个策略将引导 <code class="docutils literal"><span class="pre">Laravel</span></code> 在授权动作访问指定模型时使用何种策略：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App\Providers</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Post</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Policies\PostPolicy</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Gate</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Foundation\Support\Providers\AuthServiceProvider</span> <span class="k">as</span> <span class="nx">ServiceProvider</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AuthServiceProvider</span> <span class="k">extends</span> <span class="nx">ServiceProvider</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 应用的策略映射。</span>
<span class="sd">     *</span>
<span class="sd">     * @var array</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$policies</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nx">Post</span><span class="o">::</span><span class="na">class</span> <span class="o">=&gt;</span> <span class="nx">PostPolicy</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="sd">/**</span>
<span class="sd">     * 注册任意用户认证、用户授权服务。</span>
<span class="sd">     *</span>
<span class="sd">     * @return void</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">boot</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">registerPolicies</span><span class="p">();</span> <span class="c1">// 在底层，使用Gate来注册策略</span>

        <span class="c1">//</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h3><a class="toc-backref" href="#id35">34.3.3. 编写策略方法</a><a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h3>
<p>一旦授权策略被生成且注册，我们就可以为授权的每个动作添加方法。例如，让我们在 <code class="docutils literal"><span class="pre">PostPolicy</span></code> 中定义一个 <code class="docutils literal"><span class="pre">update</span></code> 方法，它会判断指定的 <code class="docutils literal"><span class="pre">User</span></code> 是否可以更新指定的 <code class="docutils literal"><span class="pre">Post</span></code> 实例。</p>
<p><code class="docutils literal"><span class="pre">update</span></code> 方法接受 <code class="docutils literal"><span class="pre">User</span></code> 和 <code class="docutils literal"><span class="pre">Post</span></code> 实例作为参数，并且应当返回 <code class="docutils literal"><span class="pre">true</span></code> 或 <code class="docutils literal"><span class="pre">false</span></code> 来指明用户是否授权更新指定的 <code class="docutils literal"><span class="pre">Post</span></code> 。因此，这个例子中，我们判断用户的 <code class="docutils literal"><span class="pre">id</span></code> 是否和 <code class="docutils literal"><span class="pre">post</span></code> 中的 <code class="docutils literal"><span class="pre">user_id</span></code> 匹配：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App\Policies</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\User</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Post</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">PostPolicy</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 判断指定博客能否被用户更新。</span>
<span class="sd">     *</span>
<span class="sd">     * @param  \App\User  $user</span>
<span class="sd">     * @param  \App\Post  $post</span>
<span class="sd">     * @return bool</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">update</span><span class="p">(</span><span class="nx">User</span> <span class="nv">$user</span><span class="p">,</span> <span class="nx">Post</span> <span class="nv">$post</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">===</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">user_id</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>你可以继续为此授权策略定义额外的方法，作为各种权限所需要的授权。例如，你可以定义 <code class="docutils literal"><span class="pre">view</span></code> 或 <code class="docutils literal"><span class="pre">delete</span></code> 方法来授权 <code class="docutils literal"><span class="pre">Post</span></code> 的多种行为。也可以为自定义策略方法使用自己喜欢的名字。</p>
<div class="section" id="id10">
<h4><a class="toc-backref" href="#id36">34.3.3.1. 不包含模型方法</a><a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h4>
<p>一些策略方法只接受当前认证通过的用户作为参数而不用传入授权相关的模型实例。最普遍的应用场景就是授权 <code class="docutils literal"><span class="pre">create</span></code> 动作。例如，如果正在创建一篇博客，你可能希望检查一下当前用户是否有权创建博客。</p>
<p>当定义一个不需要传入模型实例的策略方法时，比如 <code class="docutils literal"><span class="pre">create</span></code> 方法，你需要定义这个方法只接受已授权的用户作为参数：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * 判断指定用户是否可以创建博客。</span>
<span class="sd"> *</span>
<span class="sd"> * @param  \App\User  $user</span>
<span class="sd"> * @return bool</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">create</span><span class="p">(</span><span class="nx">User</span> <span class="nv">$user</span><span class="p">)</span> <span class="c1">// 不用传入模型实例</span>
<span class="p">{</span>
    <span class="c1">//</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id11">
<h4><a class="toc-backref" href="#id37">34.3.3.2. 策略过滤器</a><a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h4>
<p>对特定用户，你可能希望通过指定的策略授权所有动作。 要达到这个目的，可以在策略中定义一个 <code class="docutils literal"><span class="pre">before</span></code> 方法。 <code class="docutils literal"><span class="pre">before</span></code> 方法会在策略中其它所有方法之前执行，这样提供了一种方式来授权动作而不是指定的策略方法来执行判断。这个功能最常见的场景是授权应用的管理员可以访问所有动作：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">before</span><span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="nv">$ability</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">isSuperAdmin</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>如果你想拒绝用户所有的授权，你应该在 <code class="docutils literal"><span class="pre">before</span></code> 方法中返回 <code class="docutils literal"><span class="pre">false</span></code> 。如果返回的是 <code class="docutils literal"><span class="pre">null</span></code> ，则通过其它的策略方法来决定授权与否。</p>
</div>
</div>
<div class="section" id="id12">
<h3><a class="toc-backref" href="#id38">34.3.4. 使用策略授权动作</a><a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h3>
<div class="section" id="id13">
<h4><a class="toc-backref" href="#id39">34.3.4.1. 通过中间件</a><a class="headerlink" href="#id13" title="永久链接至标题">¶</a></h4>
<p><code class="docutils literal"><span class="pre">Laravel</span></code> 包含一个可以在请求到达路由或控制器之前就进行动作授权的中间件。默认， <code class="docutils literal"><span class="pre">Illuminate\Auth\Middleware\Authorize</span></code> 中间件被指定到 <code class="docutils literal"><span class="pre">App\Http\Kernel</span></code> 类中 <code class="docutils literal"><span class="pre">can</span></code> 键上。我们用一个授权用户更新博客的例子来讲解 <code class="docutils literal"><span class="pre">can</span></code> 中间件的使用：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">App\Post</span><span class="p">;</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">put</span><span class="p">(</span><span class="s1">&#39;/post/{post}&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Post</span> <span class="nv">$post</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 当前用户可以更新博客...</span>
<span class="p">})</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="p">(</span><span class="s1">&#39;can:update,post&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>在这个例子中，我们传递给 <code class="docutils literal"><span class="pre">can('can'</span> <span class="pre">=&gt;</span> <span class="pre">\Illuminate\Auth\Middleware\Authorize::class)</span></code> 中间件 2 个参数。 <strong>第一个是需要授权的动作的名称，第二个是我们希望传递给策略方法的路由参数。</strong> 这里因为使用了隐式模型绑定，一个 <code class="docutils literal"><span class="pre">Post</span></code> 会被传递给策略方法。<strong>如果用户不被授权访问指定的动作，这个中间件会生成带有 403 状态码的 HTTP 响应。</strong></p>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p class="last">这里有个问题，就是中间件只能接收一个权限字符串，且第二个参数可以是路由参数变量名称。</p>
</div>
<div class="section" id="id14">
<h5>34.3.4.1.1. 不需要指定模型的动作<a class="headerlink" href="#id14" title="永久链接至标题">¶</a></h5>
<p>同样的，一些动作，比如 <code class="docutils literal"><span class="pre">create</span></code> ，并不需要指定模型实例。 <strong>在这种情况下，可传递一个类名给中间件。当授权动作时，这个类名将被用来判断使用哪个策略</strong> ：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nx">Route</span><span class="o">::</span><span class="na">post</span><span class="p">(</span><span class="s1">&#39;/post&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 当前用户可以创建博客...</span>
<span class="p">})</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="p">(</span><span class="s1">&#39;can:create,App\Post&#39;</span><span class="p">);</span> <span class="c1">// 这里需要传入类名</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="gate">
<h4><a class="toc-backref" href="#id40">34.3.4.2. 通过Gate门面</a><a class="headerlink" href="#gate" title="永久链接至标题">¶</a></h4>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nx">Route</span><span class="o">::</span><span class="na">put</span><span class="p">(</span><span class="s1">&#39;posts/{post}&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">App\Post</span> <span class="nv">$post</span><span class="p">)</span> <span class="p">{</span>
   <span class="nx">abort_unless</span><span class="p">(</span><span class="nx">Gate</span><span class="o">::</span><span class="na">allows</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="nv">$post</span><span class="p">),</span> <span class="mi">403</span><span class="p">);</span> <span class="nx">抛出403响应除非Gate运行更新帖子</span>

   <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span><span class="nx">request</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">input</span><span class="p">());</span>
<span class="p">});</span>
</pre></div>
</div>
<p>我们通过 <code class="docutils literal"><span class="pre">Gate</span></code> 来调用我们策略的更新方法，并将当前通过身份验证的用户以及给定的任务（如果用户未登录， <code class="docutils literal"><span class="pre">Gate</span></code> 将自动拒绝所有查询能力操作）传递它。如果这个能力没有被授予，我们会以403中止。</p>
</div>
<div class="section" id="id15">
<h4><a class="toc-backref" href="#id41">34.3.4.3. 通过控制器辅助函数</a><a class="headerlink" href="#id15" title="永久链接至标题">¶</a></h4>
<p>除了在 <code class="docutils literal"><span class="pre">User</span></code> 模型中提供辅助方法外， <code class="docutils literal"><span class="pre">Laravel</span></code> 也为所有继承了 <code class="docutils literal"><span class="pre">App\Http\Controllers\Controller</span></code> 基类的控制器提供了一个有用的 <code class="docutils literal"><span class="pre">authorize</span></code> 方法。和 <code class="docutils literal"><span class="pre">can</span></code> 方法类似，这个方法接收需要授权的动作和相关的模型作为参数。如果动作不被授权， <code class="docutils literal"><span class="pre">authorize</span></code> 方法会抛出 <code class="docutils literal"><span class="pre">Illuminate\Auth\Access\AuthorizationException</span></code> 异常，然后被 <code class="docutils literal"><span class="pre">Laravel</span></code> 默认的异常处理器转化为带有 <code class="docutils literal"><span class="pre">403</span></code> 状态码的 <code class="docutils literal"><span class="pre">HTTP</span></code> 响应：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App\Http\Controllers</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Post</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Http\Controllers\Controller</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">PostController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 更新指定博客。</span>
<span class="sd">     *</span>
<span class="sd">     * @param  Request  $request</span>
<span class="sd">     * @param  Post  $post</span>
<span class="sd">     * @return Response</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">update</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">Post</span> <span class="nv">$post</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">authorize</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span> <span class="c1">//未被授权则抛出异常</span>

        <span class="c1">// 或则</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">authorize</span><span class="p">(</span><span class="nv">$post</span><span class="p">);</span>
        <span class="c1">// 当前用户可以更新博客...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p class="last">在控制器方法中进行授权验证时， <code class="docutils literal"><span class="pre">authorize</span></code> 方法中不用提供第一个权限名称参数，该方法会自定猜测，并传入。</p>
</div>
<div class="section" id="id16">
<h5>34.3.4.3.1. 不需要指定模型的动作<a class="headerlink" href="#id16" title="永久链接至标题">¶</a></h5>
<p>和之前讨论的一样，一些动作，比如 <code class="docutils literal"><span class="pre">create</span></code> ，并不需要指定模型实例。在这种情况下，可传递一个类名给 <code class="docutils literal"><span class="pre">authorize</span></code> 方法。当授权动作时，这个类名将被用来判断使用哪个策略：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * 新建博客</span>
<span class="sd"> *</span>
<span class="sd"> * @param  Request  $request</span>
<span class="sd"> * @return Response</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">create</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">authorize</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="nx">Post</span><span class="o">::</span><span class="na">class</span><span class="p">);</span> <span class="c1">// 传入类名称</span>

    <span class="c1">// 当前用户可以新建博客...</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id17">
<h5>34.3.4.3.2. 自动能力命名<a class="headerlink" href="#id17" title="永久链接至标题">¶</a></h5>
<p>当你在控制器中调用 <code class="docutils literal"><span class="pre">authorize</span></code> 方法时，允许你省略能力名称。当没有给方法提供能力名称， <code class="docutils literal"><span class="pre">Laravel</span></code> 会自动从控制器方法中获取能力名称。</p>
<p>在我们样例控制器中，调用 <code class="docutils literal"><span class="pre">$this-&gt;authorize($post)</span></code> 将会访问 <code class="docutils literal"><span class="pre">PostPolicy&#64;update</span></code> 策略方法。</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">PostController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 更新指定博客。</span>
<span class="sd">     *</span>
<span class="sd">     * @param  Request  $request</span>
<span class="sd">     * @param  Post  $post</span>
<span class="sd">     * @return Response</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">update</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">Post</span> <span class="nv">$post</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">authorize</span><span class="p">(</span><span class="nv">$post</span><span class="p">);</span>

        <span class="c1">// 当前用户可以更新博客...</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">create</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">authorize</span><span class="p">(</span><span class="nx">Post</span><span class="o">::</span><span class="na">class</span><span class="p">);</span> <span class="c1">// 传入类名称</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id18">
<h5>34.3.4.3.3. 匹配方法名称的能力名称存在的问题<a class="headerlink" href="#id18" title="永久链接至标题">¶</a></h5>
<ul>
<li><p class="first">在控制器外部检查能力。控制器方法名称不总是直观反映检查能力名称。例如</p>
<div class="highlight-html"><div class="highlight"><pre><span></span>@foreach ($tasks as $task)
    @if ($user-&gt;can(&#39;show&#39;, $task))
        <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{ url(&#39;tasks&#39;, $task) }}&quot;</span><span class="p">&gt;</span>View task<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
    @endif
@endforeach
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">show</span></code> 能力名称语义不清晰，应该使用 <code class="docutils literal"><span class="pre">view</span></code> 。</p>
</li>
<li><p class="first">重复策略名称。 策略中 <code class="docutils literal"><span class="pre">create</span></code> 和 <code class="docutils literal"><span class="pre">store</span></code> 方法使用相同的检查逻辑，即决定我们是否允许用户随后存储该任务。映射控制器方法名称导致策略存在两个相同逻辑的方法。</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">App\User</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">TaskPolicy</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">create</span><span class="p">(</span><span class="nx">User</span> <span class="nv">$user</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// check if the user can create new tasks</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">store</span><span class="p">(</span><span class="nx">User</span> <span class="nv">$user</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// check if the user can create new tasks</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>同样的问题存在于 <code class="docutils literal"><span class="pre">edit</span></code> 和 <code class="docutils literal"><span class="pre">update</span></code> 方法。</p>
</li>
</ul>
</div>
<div class="section" id="id19">
<h5>34.3.4.3.4. 规范化能力名称<a class="headerlink" href="#id19" title="永久链接至标题">¶</a></h5>
<p>在 <code class="docutils literal"><span class="pre">laravel</span> <span class="pre">5.3</span></code> 中，自动能力名称正在升级。取代盲目使用方法名称， <code class="docutils literal"><span class="pre">laravel</span></code> 会根据您要完成的操作选择一个合理的能力名称。</p>
<p><code class="docutils literal"><span class="pre">laravel</span></code> 通过方法和能力之间的简单映射来做到这一点。</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="p">[</span>
    <span class="s1">&#39;show&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;view&#39;</span><span class="p">,</span>
    <span class="s1">&#39;create&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span>
    <span class="s1">&#39;store&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span>
    <span class="s1">&#39;edit&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span>
    <span class="s1">&#39;update&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span>
    <span class="s1">&#39;destroy&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
<p>这会自动发生，不用更改控制器中的代码。您现在可以使用 <code class="docutils literal"><span class="pre">$user-&gt;can('view'，$task)</span></code> 检查视图，这更直观。</p>
<p>既然控制器并不总是使用与控制器方法匹配的能力名称来调用 <code class="docutils literal"><span class="pre">Gate</span></code> ，对应的策略类应该不再具有这些方法：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">App\Task</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">TaskController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">create</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">authorize</span><span class="p">(</span><span class="nx">Task</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">view</span><span class="p">(</span><span class="s1">&#39;tasks.create&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">store</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">authorize</span><span class="p">(</span><span class="nx">Task</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

        <span class="nx">Task</span><span class="o">::</span><span class="na">create</span><span class="p">(</span><span class="nx">request</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">input</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>你只需要一个 <code class="docutils literal"><span class="pre">create()</span></code> 方法即可：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">TaskPolicy</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">create</span><span class="p">(</span><span class="nx">User</span> <span class="nv">$user</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// check if the user can create tasks</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>该 <code class="docutils literal"><span class="pre">create</span></code> 策略方法将被控制器中的 <code class="docutils literal"><span class="pre">create</span></code> 和 <code class="docutils literal"><span class="pre">store</span></code> 调用。</p>
</div>
<div class="section" id="id20">
<h5>34.3.4.3.5. 授权一个完整的资源控制器<a class="headerlink" href="#id20" title="永久链接至标题">¶</a></h5>
<p>在控制器中，存在一个 <code class="docutils literal"><span class="pre">authorizeResource</span></code> 方法，使用该方法可以清空所有控制器中的授权检查方法。它替换了所有位于控制器方法中的 <code class="docutils literal"><span class="pre">authorize</span></code> 方法。</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">TaskController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">authorizeResource</span><span class="p">(</span><span class="nx">Post</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// ... all resource methods ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>现在，你不必在控制器器方法中单个调用 <code class="docutils literal"><span class="pre">authorize</span></code> 方法。 <code class="docutils literal"><span class="pre">laravel</span></code> 现在将自动检查任何给定动作的正确能力。</p>
</div>
</div>
<div class="section" id="id21">
<h4><a class="toc-backref" href="#id42">34.3.4.4. 通过用户模型</a><a class="headerlink" href="#id21" title="永久链接至标题">¶</a></h4>
<p><code class="docutils literal"><span class="pre">Laravel</span></code> 应用内置的 <code class="docutils literal"><span class="pre">User</span></code> 模型包含 2 个有用的方法来授权动作： <code class="docutils literal"><span class="pre">can</span></code> 和 <code class="docutils literal"><span class="pre">cant</span></code> 。 <code class="docutils literal"><span class="pre">can</span></code>  方法需要指定授权的动作和相关的模型。例如，判定一个用户是否授权更新指定的 <code class="docutils literal"><span class="pre">Post</span></code> 模型：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">can</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="nv">$post</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">//</span>
<span class="p">}</span>
</pre></div>
</div>
<p>如果指定模型的策略已被注册， <code class="docutils literal"><span class="pre">can</span></code> 方法会自动调用模型的策略方法并且返回 <code class="docutils literal"><span class="pre">boolean</span></code> 值。如果没有策略注册到这个模型， <code class="docutils literal"><span class="pre">can</span></code> 方法会尝试调用和动作名相匹配的基于闭包的 <code class="docutils literal"><span class="pre">Gate</span></code> 。</p>
<div class="section" id="id22">
<h5>34.3.4.4.1. 不需要指定模型的动作<a class="headerlink" href="#id22" title="永久链接至标题">¶</a></h5>
<p>记住，一些动作，比如 <code class="docutils literal"><span class="pre">create</span></code> 并不需要指定模型实例。在这种情况下，可传递一个类名给 <code class="docutils literal"><span class="pre">can</span></code> 方法。当授权动作时，这个类名将被用来判断使用哪个策略：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">App\Post</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">can</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="nx">Post</span><span class="o">::</span><span class="na">class</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// 传入类的名称</span>
    <span class="c1">// 执行相关策略中的「create」方法...</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="blade">
<h4><a class="toc-backref" href="#id43">34.3.4.5. 通过Blade模板</a><a class="headerlink" href="#blade" title="永久链接至标题">¶</a></h4>
<p>当编写 <code class="docutils literal"><span class="pre">Blade</span></code> 模板时，你可能希望页面的指定部分只展示给允许授权访问指定动作的用户。 例如，你可能希望只展示更新表单给有权更新博客的用户。这种情况下，你可以直接使用 <code class="docutils literal"><span class="pre">&#64;can</span></code> 和 <code class="docutils literal"><span class="pre">&#64;cannot</span></code> 指令。</p>
<div class="highlight-html"><div class="highlight"><pre><span></span>@can(&#39;update&#39;, $post)
    <span class="c">&lt;!-- 当前用户可以更新博客 --&gt;</span>
@elsecan(&#39;create&#39;, $post)
    <span class="c">&lt;!-- 当前用户可以新建博客 --&gt;</span>
@endcan

@cannot(&#39;update&#39;, $post)
    <span class="c">&lt;!-- 当前用户不可以更新博客 --&gt;</span>
@elsecannot(&#39;create&#39;, $post)
    <span class="c">&lt;!-- 当前用户不可以新建博客 --&gt;</span>
@endcannot
</pre></div>
</div>
<p>这些指令在编写 <code class="docutils literal"><span class="pre">&#64;if</span></code> 和 <code class="docutils literal"><span class="pre">&#64;unless</span></code> 时提供了方便的缩写。 <code class="docutils literal"><span class="pre">&#64;can</span></code> 和 <code class="docutils literal"><span class="pre">&#64;cannot</span></code> 各自转化为如下对应的语句：</p>
<div class="highlight-html"><div class="highlight"><pre><span></span>@if (Auth::user()-&gt;can(&#39;update&#39;, $post))
    <span class="c">&lt;!-- 当前用户可以更新博客 --&gt;</span>
@endif

@unless (Auth::user()-&gt;can(&#39;update&#39;, $post))
    <span class="c">&lt;!-- 当前用户不可以更新博客 --&gt;</span>
@endunless
</pre></div>
</div>
<div class="section" id="id23">
<h5>34.3.4.5.1. 不需要指定模型的动作<a class="headerlink" href="#id23" title="永久链接至标题">¶</a></h5>
<p>和大部分其它的授权方法类似，当动作不需要模型实例时，你可以传递一个类名给 <code class="docutils literal"><span class="pre">&#64;can</span></code> 和 <code class="docutils literal"><span class="pre">&#64;cannot</span></code> 指令：</p>
<div class="highlight-html"><div class="highlight"><pre><span></span>@can(&#39;create&#39;, App\Post::class)
    <span class="c">&lt;!-- 当前用户可以新建博客 --&gt;</span>
@endcan

@cannot(&#39;create&#39;, App\Post::class)
    <span class="c">&lt;!-- 当前用户不可以新建博客 --&gt;</span>
@endcannot
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="id24">
<h2><a class="toc-backref" href="#id44">34.4. Laravel常用的授权包</a><a class="headerlink" href="#id24" title="永久链接至标题">¶</a></h2>
<p><a class="reference external" href="https://laravel-news.com/two-best-roles-permissions-packages">角色权限包</a></p>
<p><a class="reference external" href="https://github.com/JosephSilber/bouncer">https://github.com/JosephSilber/bouncer</a></p>
<p><a class="reference external" href="https://github.com/spatie/laravel-permission">https://github.com/spatie/laravel-permission</a></p>
<p><a class="reference external" href="https://github.com/santigarcor/laratrust">https://github.com/santigarcor/laratrust</a></p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Laravel的命令行.html" class="btn btn-neutral float-right" title="35. 命令行" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Laravel的API认证系统Passport.html" class="btn btn-neutral" title="33. Laravel 的 API 认证系统 Passport" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, lzh.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.0',
            LANGUAGE:'zh',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  

<script type="text/javascript">
  
      $(document).ready(function(){
        var offset = sessionStorage.getItem("offsetTop");
        $('.wy-side-scroll').scrollTop(offset);
        sessionStorage.setItem("offsetTop", 0);


        $('.wy-menu > ul').click(function(){
            sessionStorage.setItem("offsetTop", $('.wy-side-scroll').scrollTop());
        });
      })

  </script> 

</body>
</html>